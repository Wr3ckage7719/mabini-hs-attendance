<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendance Reports - Mabini HS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="../assets/css/admin-theme.css">
    <script>
        (function(){
            try{
                const userData=sessionStorage.getItem('userData');
                if(userData){
                    const user=JSON.parse(userData);
                    window.__userProfileData = {
                        name: user.fullName||'System Administrator',
                        role: user.role ? user.role.charAt(0).toUpperCase()+user.role.slice(1) : 'Admin',
                        initials: (user.fullName||'SA').split(' ').map(function(n){return n[0]}).join('').toUpperCase().slice(0,2)
                    };
                } else {
                    window.__userProfileData = {name:'System Administrator',role:'Admin',initials:'SA'};
                }
            }catch(e){
                window.__userProfileData = {name:'System Administrator',role:'Admin',initials:'SA'};
            }
        })();
    </script>
    <link rel="stylesheet" href="../assets/css/responsive-nav.css">
    <link rel="stylesheet" href="../assets/css/responsive-tables.css">
    <link rel="stylesheet" href="../assets/css/table-improvements.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script>(function(){const t=localStorage.getItem('theme'),p=window.matchMedia('(prefers-color-scheme: dark)').matches,theme=t||(p?'dark':'light');document.documentElement.setAttribute('data-theme',theme);document.documentElement.setAttribute('data-bs-theme',theme);})();</script>
    <style>
        /* Fix modal z-index issue */
        .modal {
            z-index: 1060 !important;
        }
        .modal-backdrop {
            z-index: 1050 !important;
        }
        .modal-dialog {
            z-index: 1070 !important;
        }
    </style>
    <script src="../assets/js/theme.js" defer></script>
</head>
<body>
    <button class="sidebar-toggle" onclick="toggleSidebar()" style="display: none;">
        <i class="bi bi-list"></i>
    </button>
    <div class="sidebar-backdrop" onclick="closeSidebar()"></div>
    <div class="admin-layout">
        <!-- Sidebar -->
        <aside class="admin-sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <i class="bi bi-mortarboard-fill"></i>
                    <span>Mabini HS</span>
                </div>
                <div class="sidebar-subtitle">Attendance System</div>
            </div>

            <div class="sidebar-menu">
                <div class="menu-label">Main</div>
                <a href="dashboard.html" class="menu-item">
                    <i class="bi bi-speedometer2"></i>
                    <span>Dashboard</span>
                </a>

            <div class="menu-label">Management</div>
            <a href="students.html" class="menu-item">
                <i class="bi bi-people-fill"></i>
                <span>Students</span>
            </a>
            <a href="teachers.html" class="menu-item">
                <i class="bi bi-person-video3"></i>
                <span>Teachers</span>
            </a>
            <a href="sections.html" class="menu-item">
                <i class="bi bi-grid-3x3-gap-fill"></i>
                <span>Sections & Classes</span>
            </a>
            <a href="subjects.html" class="menu-item">
                <i class="bi bi-book-fill"></i>
                <span>Subjects</span>
            </a>
            <a href="teaching-loads.html" class="menu-item">
                <i class="bi bi-calendar-check-fill"></i>
                <span>Teaching Loads</span>
            </a>
            <a href="users.html" class="menu-item">
                <i class="bi bi-person-badge-fill"></i>
                <span>Users & Staff</span>
            </a>                <div class="menu-label">Reports</div>
                <a href="reports.html" class="menu-item active">
                    <i class="bi bi-bar-chart-fill"></i>
                    <span>Analytics</span>
                </a>
                <a href="notifications.html" class="menu-item">
                    <i class="bi bi-megaphone-fill"></i>
                    <span>Student Notifications</span>
                </a>
                <a href="sms-notifications.html" class="menu-item">
                    <i class="bi bi-chat-dots-fill"></i>
                    <span>SMS Notifications</span>
                </a>
                <!-- Change Password removed per request -->
            </div>

            <div class="sidebar-footer">
                <div class="user-profile">
                    <div class="user-avatar" id="userAvatar"><script>document.write(window.__userProfileData.initials)</script></div>
                    <div class="user-details">
                        <div class="user-name" id="userName"><script>document.write(window.__userProfileData.name)</script></div>
                        <div class="user-role" id="userRole"><script>document.write(window.__userProfileData.role)</script></div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="admin-main">
            <!-- Shared header -->
            <header class="admin-top" role="banner">
                <div style="display:flex;flex-direction:column;">
                    <div class="admin-breadcrumb muted">
                        <span class="muted">Admin</span>
                        <span aria-hidden="true">/</span>
                        <span id="admin-section">Reports</span>
                    </div>
                    <div class="admin-title">Attendance Reports</div>
                </div>

                <div class="admin-top-actions">
                    <button id="themeToggle" class="theme-toggle" aria-pressed="false" aria-label="Toggle theme">
                        <span class="icon sun" aria-hidden="true" style="display:inline-block">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="4" stroke="currentColor" stroke-width="1.2"/><path d="M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2M4.93 19.07l1.41-1.41M17.66 6.34l1.41-1.41" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                        </span>
                        <span class="icon moon" aria-hidden="true" style="display:none">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                        </span>
                    </button>

                    <div style="display:flex;align-items:center;gap:10px">
                        <div class="avatar" title="Administrator" aria-hidden="true">
                            <svg width="38" height="38" viewBox="0 0 24 24" fill="none"><circle cx="12" cy="8" r="3" stroke="currentColor" stroke-width="1.2"/><path d="M4 20c1.5-4 6-6 8-6s6.5 2 8 6" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                        </div>
                        <button id="logoutBtn" class="btn btn-danger" aria-label="Logout">Logout</button>
                    </div>
                </div>
            </header>

            <div class="content-area">
                <!-- Filters Card -->
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="mb-0"><i class="bi bi-funnel"></i> Filters & Options</h6>
                        <div class="d-flex gap-2">
                            <button class="btn btn-sm btn-outline-secondary" onclick="resetFilters()">
                                <i class="bi bi-arrow-counterclockwise"></i> Reset
                            </button>
                            <button class="btn btn-sm btn-success" onclick="exportToCSV()">
                                <i class="bi bi-download"></i> Export CSV
                            </button>
                            <button class="btn btn-sm btn-primary" onclick="printReport()">
                                <i class="bi bi-printer"></i> Print
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Quick Date Presets -->
                        <div class="row mb-3">
                            <div class="col-12">
                                <label class="form-label fw-bold">Quick Date Range:</label>
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="setDateRange('today')">Today</button>
                                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="setDateRange('yesterday')">Yesterday</button>
                                    <button type="button" class="btn btn-sm btn-outline-primary active" onclick="setDateRange('last7days')">Last 7 Days</button>
                                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="setDateRange('last30days')">Last 30 Days</button>
                                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="setDateRange('thisMonth')">This Month</button>
                                </div>
                            </div>
                        </div>

                        <!-- Custom Filters -->
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label class="form-label">From Date</label>
                                <input type="date" class="form-control form-control-sm" id="dateFrom" onchange="loadReport()">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">To Date</label>
                                <input type="date" class="form-control form-control-sm" id="dateTo" onchange="loadReport()">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Status</label>
                                <select class="form-select form-select-sm" id="statusFilter" onchange="loadReport()">
                                    <option value="">All</option>
                                    <option value="present">Present Only</option>
                                    <option value="late">Late Only</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Grade Level</label>
                                <select class="form-select form-select-sm" id="gradeLevelFilter" onchange="loadReport()">
                                    <option value="">All Grades</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Section</label>
                                <select class="form-select form-select-sm" id="blockFilter" onchange="loadReport()">
                                    <option value="">All Sections</option>
                                </select>
                            </div>
                        </div>

                        <!-- Search Bar -->
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <label class="form-label">Search Student</label>
                                <input type="text" class="form-control form-control-sm" id="searchStudent" placeholder="Search by name or student ID..." oninput="loadReport()">
                            </div>
                        </div>

                        <!-- Active Filters Display -->
                        <div class="row mt-3" id="activeFiltersRow" style="display: none;">
                            <div class="col-12">
                                <div class="alert alert-info py-2 mb-0">
                                    <i class="bi bi-info-circle"></i> <span id="filterSummary"></span>
                                    <span id="activeFilterBadges" class="ms-2"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Charts Section -->
                <div class="row mb-4" style="margin-top: 20px;">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="bi bi-graph-up"></i> Attendance Trend (Last 7 Days)</h6>
                            </div>
                            <div class="card-body">
                                <canvas id="attendanceTrendChart" height="60"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="bi bi-clock-history"></i> Attendance by Hour</h6>
                            </div>
                            <div class="card-body">
                                <canvas id="hourlyChart" height="120"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="bi bi-grid-3x3-gap"></i> Top 5 Sections by Attendance</h6>
                            </div>
                            <div class="card-body">
                                <canvas id="sectionChart" height="120"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="table-container">
                    <h2 style="margin: 20px 25px 15px; color: #001f5b; font-size: 18px; font-weight: 600;">Attendance Details</h2>
                    <table id="reportTable">
                        <thead id="reportTableHead">
                            <tr>
                                <th>Student ID</th>
                                <th>Name</th>
                                <th>Section</th>
                                <th>Subject</th>
                                <th>Date</th>
                                <th>Time In</th>
                                <th>Time Out</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="reportTableBody">
                            <tr>
                                <td colspan="8" class="loading">Loading reports...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- Mobile Toggle -->
    <div class="mobile-toggle" onclick="toggleSidebar()">
        <i class="bi bi-list"></i>
    </div>

    <script src="../shared/js/toast.js"></script>
    <script src="../shared/js/confirm-modal.js"></script>
    <script src="../shared/js/empty-state.js"></script>
    <script src="../shared/js/loading.js"></script>
    <script type="module" src="js/admin-common.js"></script>
    <script type="module">
        // NOTE: getDocuments function is provided by admin-common.js
        // Wait for admin-common.js to load
        
        let allLogs = [];
        let allStudents = [];
        let allSections = [];
        let allSubjects = [];
        let allTeachingLoads = [];
        
        // Chart instances
        let attendanceTrendChart = null;
        let hourlyChart = null;
        let sectionChart = null;
        
        // Wait for admin-common.js functions to be available
        await new Promise(resolve => {
            if (window.getDocuments) {
                resolve();
            } else {
                const checkInterval = setInterval(() => {
                    if (window.getDocuments) {
                        clearInterval(checkInterval);
                        resolve();
                    }
                }, 50);
            }
        });
        
        // Set default dates (Last 7 Days)
        const today = new Date();
        const todayStr = today.toISOString().split('T')[0];
        const sevenDaysAgo = new Date();
        sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
        const sevenDaysAgoStr = sevenDaysAgo.toISOString().split('T')[0];
        
        document.getElementById('dateFrom').value = sevenDaysAgoStr;
        document.getElementById('dateTo').value = todayStr;
        
        // Quick date range presets
        window.setDateRange = function(range) {
            const today = new Date();
            let fromDate = new Date();
            let toDate = new Date();
            
            // Remove active class from all buttons
            document.querySelectorAll('.btn-group .btn').forEach(btn => btn.classList.remove('active'));
            
            switch(range) {
                case 'today':
                    fromDate = today;
                    toDate = today;
                    event.target.classList.add('active');
                    break;
                case 'yesterday':
                    fromDate.setDate(today.getDate() - 1);
                    toDate.setDate(today.getDate() - 1);
                    event.target.classList.add('active');
                    break;
                case 'last7days':
                    fromDate.setDate(today.getDate() - 7);
                    toDate = today;
                    event.target.classList.add('active');
                    break;
                case 'last30days':
                    fromDate.setDate(today.getDate() - 30);
                    toDate = today;
                    event.target.classList.add('active');
                    break;
                case 'thisMonth':
                    fromDate = new Date(today.getFullYear(), today.getMonth(), 1);
                    toDate = today;
                    event.target.classList.add('active');
                    break;
            }
            
            document.getElementById('dateFrom').value = fromDate.toISOString().split('T')[0];
            document.getElementById('dateTo').value = toDate.toISOString().split('T')[0];
            loadReport();
        };
        
        // Reset all filters
        window.resetFilters = function() {
            // Reset to last 7 days
            setDateRange('last7days');
            document.getElementById('statusFilter').value = '';
            document.getElementById('gradeLevelFilter').value = '';
            document.getElementById('blockFilter').value = '';
            document.getElementById('searchStudent').value = '';
            loadReport();
        };
        
        // Print report
        window.printReport = function() {
            window.print();
        };
        
        // Update filter summary
        function updateFilterSummary(filteredCount, totalCount) {
            const activeFiltersRow = document.getElementById('activeFiltersRow');
            const filterSummary = document.getElementById('filterSummary');
            const activeFilterBadges = document.getElementById('activeFilterBadges');
            
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;
            const status = document.getElementById('statusFilter').value;
            const gradeLevel = document.getElementById('gradeLevelFilter').value;
            const section = document.getElementById('blockFilter').value;
            const search = document.getElementById('searchStudent').value;
            
            let badges = [];
            
            if (status) badges.push(`<span class="badge bg-primary">${status === 'present' ? 'Present Only' : 'Late Only'}</span>`);
            if (gradeLevel) {
                const gradeName = document.getElementById('gradeLevelFilter').options[document.getElementById('gradeLevelFilter').selectedIndex].text;
                badges.push(`<span class="badge bg-info">${gradeName}</span>`);
            }
            if (section) {
                const sectionName = document.getElementById('blockFilter').options[document.getElementById('blockFilter').selectedIndex].text;
                badges.push(`<span class="badge bg-success">${sectionName}</span>`);
            }
            if (search) badges.push(`<span class="badge bg-warning text-dark">Search: "${search}"</span>`);
            
            const dateRange = dateFrom === dateTo ? new Date(dateFrom).toLocaleDateString() : 
                              `${new Date(dateFrom).toLocaleDateString()} - ${new Date(dateTo).toLocaleDateString()}`;
            
            filterSummary.textContent = `Showing ${filteredCount} of ${totalCount} records for ${dateRange}`;
            activeFilterBadges.innerHTML = badges.join(' ');
            
            if (badges.length > 0 || filteredCount !== totalCount) {
                activeFiltersRow.style.display = 'block';
            } else {
                activeFiltersRow.style.display = 'none';
            }
        }
        
        // Initialize charts
        function initCharts() {
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            const textColor = isDark ? '#e0e0e0' : '#666';
            const gridColor = isDark ? '#444' : '#e0e0e0';
            
            Chart.defaults.color = textColor;
            Chart.defaults.borderColor = gridColor;
            
            // Attendance Trend Chart (Line)
            const trendCtx = document.getElementById('attendanceTrendChart');
            if (trendCtx) {
                attendanceTrendChart = new Chart(trendCtx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Present',
                            data: [],
                            borderColor: '#28a745',
                            backgroundColor: 'rgba(40, 167, 69, 0.1)',
                            tension: 0.4,
                            fill: true
                        }, {
                            label: 'Absent',
                            data: [],
                            borderColor: '#dc3545',
                            backgroundColor: 'rgba(220, 53, 69, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: true }
                        },
                        scales: {
                            y: { beginAtZero: true }
                        }
                    }
                });
            }
            
            // Hourly Chart (Bar)
            const hourlyCtx = document.getElementById('hourlyChart');
            if (hourlyCtx) {
                hourlyChart = new Chart(hourlyCtx, {
                    type: 'bar',
                    data: {
                        labels: ['6 AM', '7 AM', '8 AM', '9 AM', '10 AM', '11 AM', '12 PM', '1 PM'],
                        datasets: [{
                            label: 'Check-ins',
                            data: [0, 0, 0, 0, 0, 0, 0, 0],
                            backgroundColor: '#007bff',
                            borderRadius: 5
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: { beginAtZero: true }
                        }
                    }
                });
            }
            
            // Section Chart (Horizontal Bar)
            const sectionCtx = document.getElementById('sectionChart');
            if (sectionCtx) {
                sectionChart = new Chart(sectionCtx, {
                    type: 'bar',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Attendance Rate (%)',
                            data: [],
                            backgroundColor: '#17a2b8',
                            borderRadius: 5
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            x: { 
                                beginAtZero: true,
                                max: 100
                            }
                        }
                    }
                });
            }
        }
        
        // Update charts with data
        function updateCharts(logs) {
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;
            
            // Update Attendance Trend Chart (Last 7 Days)
            updateTrendChart(logs);
            
            // Update Hourly Chart
            updateHourlyChart(logs);
            
            // Update Section Chart
            updateSectionChart(logs);
        }
        
        function updateTrendChart(logs) {
            if (!attendanceTrendChart) return;
            
            const last7Days = [];
            const presentData = [];
            const absentData = [];
            
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                last7Days.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
                
                const dayLogs = logs.filter(log => log.date === dateStr);
                
                const uniquePresent = new Set(
                    dayLogs
                        .filter(log => log.status && log.status.toLowerCase() !== 'absent')
                        .map(log => log.student_id)
                ).size;
                const absent = allStudents.length - uniquePresent;
                
                presentData.push(uniquePresent);
                absentData.push(absent);
            }
            
            attendanceTrendChart.data.labels = last7Days;
            attendanceTrendChart.data.datasets[0].data = presentData;
            attendanceTrendChart.data.datasets[1].data = absentData;
            attendanceTrendChart.update();
        }
        
        function updateHourlyChart(logs) {
            if (!hourlyChart) return;
            
            const todayStr = new Date().toISOString().split('T')[0];
            const todayLogs = logs.filter(log => log.date === todayStr);
            
            const hourCounts = [0, 0, 0, 0, 0, 0, 0, 0]; // 6 AM to 1 PM
            
            todayLogs.forEach(log => {
                if (!log.time_in) return;
                const timeParts = log.time_in.split(':');
                const hour = parseInt(timeParts[0]);
                if (hour >= 6 && hour <= 13) {
                    hourCounts[hour - 6]++;
                }
            });
            
            hourlyChart.data.datasets[0].data = hourCounts;
            hourlyChart.update();
        }
        
        function updateSectionChart(logs) {
            if (!sectionChart) return;
            
            const todayStr = new Date().toISOString().split('T')[0];
            const todayLogs = logs.filter(log => log.date === todayStr);
            
            const sectionStats = allSections.map(section => {
                const studentsInSection = allStudents.filter(s => s.section_id === section.id);
                const totalInSection = studentsInSection.length;
                
                if (totalInSection === 0) return { name: section.section_name, rate: 0 };
                
                const presentInSection = new Set(
                    todayLogs
                        .filter(log => log.section_id === section.id && log.status && log.status.toLowerCase() !== 'absent')
                        .map(log => log.student_id)
                ).size;
                
                const rate = ((presentInSection / totalInSection) * 100).toFixed(1);
                return { name: section.section_name, rate: parseFloat(rate) };
            });
            
            // Sort and get top 5
            sectionStats.sort((a, b) => b.rate - a.rate);
            const top5 = sectionStats.slice(0, 5);
            
            sectionChart.data.labels = top5.map(s => s.name);
            sectionChart.data.datasets[0].data = top5.map(s => s.rate);
            sectionChart.update();
        }
        
        // Load data
        async function init() {
            try {
                // Load students
                allStudents = await window.getDocuments('students');
                
                // Load sections
                allSections = await window.getDocuments('sections');
                
                // Load subjects
                allSubjects = await window.getDocuments('subjects');
                
                // Load teaching loads
                allTeachingLoads = await window.getDocuments('teaching_loads');
                
                const blockFilter = document.getElementById('blockFilter');
                blockFilter.innerHTML = '<option value="">All Sections</option>' +
                    allSections.map(block => `<option value="${block.id}">${block.section_name}</option>`).join('');
                
                // Populate grade level filter
                const gradeLevels = [...new Set(allSections.map(s => s.grade_level).filter(g => g))].sort();
                const gradeLevelFilter = document.getElementById('gradeLevelFilter');
                gradeLevelFilter.innerHTML = '<option value="">All Grades</option>' +
                    gradeLevels.map(grade => `<option value="${grade}">Grade ${grade}</option>`).join('');
                
                // Load attendance records
                allLogs = await window.getDocuments('attendance');
                
                // Debug: Check data quality
                console.log('Data loaded:', {
                    students: allStudents.length,
                    sections: allSections.length,
                    subjects: allSubjects.length,
                    teachingLoads: allTeachingLoads.length,
                    attendanceLogs: allLogs.length
                });
                
                // Debug: Check subject coverage in attendance
                const logsWithSubject = allLogs.filter(log => log.subject_id).length;
                const logsWithTeachingLoad = allLogs.filter(log => log.teaching_load_id).length;
                console.log('Attendance data quality:', {
                    totalLogs: allLogs.length,
                    withSubjectId: logsWithSubject,
                    withTeachingLoadId: logsWithTeachingLoad,
                    missingBoth: allLogs.length - Math.max(logsWithSubject, logsWithTeachingLoad)
                });
                
                // Initialize charts
                initCharts();
                
                loadReport();
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }
        
        window.loadReport = async function() {
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;
            const blockFilter = document.getElementById('blockFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            const gradeLevelFilter = document.getElementById('gradeLevelFilter').value;
            const searchStudent = document.getElementById('searchStudent').value.toLowerCase().trim();
            
            const totalLogs = allLogs.length;
            
            // Filter logs by date range
            let filteredLogs = allLogs.filter(log => {
                const logDate = log.date;
                return logDate >= dateFrom && logDate <= dateTo;
            });
            
            // Filter by grade level
            if (gradeLevelFilter) {
                const sectionsInGrade = allSections
                    .filter(s => s.grade_level === gradeLevelFilter)
                    .map(s => s.id);
                const studentsInGrade = allStudents
                    .filter(st => sectionsInGrade.includes(st.section_id))
                    .map(st => st.student_number);
                filteredLogs = filteredLogs.filter(log => studentsInGrade.includes(log.student_id));
            }
            
            // Filter by section if selected
            if (blockFilter) {
                const studentsInBlock = allStudents
                    .filter(s => s.section_id === blockFilter)
                    .map(s => s.student_number);
                filteredLogs = filteredLogs.filter(log => studentsInBlock.includes(log.student_id));
            }
            
            // Filter by status (present/late/absent)
            if (statusFilter) {
                filteredLogs = filteredLogs.filter(log => {
                    if (statusFilter === 'late') {
                        return log.status && log.status.toLowerCase() === 'late';
                    } else if (statusFilter === 'present') {
                        return log.status && log.status.toLowerCase() === 'present';
                    }
                    return true;
                });
            }
            
            // Filter by search term
            if (searchStudent) {
                filteredLogs = filteredLogs.filter(log => {
                    const student = allStudents.find(s => s.student_number === log.student_id);
                    if (!student) return false;
                    const fullName = `${student.first_name} ${student.last_name}`.toLowerCase();
                    const studentNumber = (student.student_number || '').toLowerCase();
                    return fullName.includes(searchStudent) || studentNumber.includes(searchStudent);
                });
            }
            
            // Update filter summary
            updateFilterSummary(filteredLogs.length, totalLogs);
            
            // Update charts
            updateCharts(filteredLogs);
            
            // Render table
            renderReport(filteredLogs);
        };
        
        function renderReport(logs) {
            const tbody = document.getElementById('reportTableBody');
            
            if (logs.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="empty-state">
                            <h3>No attendance records found</h3>
                            <p>Try adjusting the filters above</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Sort logs by date (newest first)
            logs.sort((a, b) => {
                const dateCompare = new Date(b.date) - new Date(a.date);
                if (dateCompare !== 0) return dateCompare;
                return (b.time_in || '').localeCompare(a.time_in || '');
            });
            
            tbody.innerHTML = logs.map(log => {
                const student = allStudents.find(s => s.id === log.student_id);
                const section = allSections.find(b => b.id === log.section_id);
                
                // Try to get subject - first from direct subject_id, then from teaching_load_id
                let subject = null;
                if (log.subject_id) {
                    subject = allSubjects.find(s => s.id === log.subject_id);
                } else if (log.teaching_load_id) {
                    // Fallback: get subject from teaching load
                    const teachingLoad = allTeachingLoads.find(tl => tl.id === log.teaching_load_id);
                    if (teachingLoad && teachingLoad.subject_id) {
                        subject = allSubjects.find(s => s.id === teachingLoad.subject_id);
                    }
                }
                
                const status = log.status || 'present';
                const statusClass = status.toLowerCase() === 'late' ? 'badge-late' : 
                                   status.toLowerCase() === 'absent' ? 'badge-absent' : 'badge-present';
                
                const formattedDate = log.date ? new Date(log.date).toLocaleDateString() : '-';
                const timeIn = log.time_in || '-';
                const timeOut = log.time_out || '-';
                
                return `
                    <tr>
                        <td>${student?.student_number || log.student_id || '-'}</td>
                        <td>${student ? `${student.first_name} ${student.last_name}` : 'Unknown'}</td>
                        <td>${section ? section.section_name : '-'}</td>
                        <td>${subject ? subject.name || subject.subject_name || 'Unknown Subject' : 'Not Assigned'}</td>
                        <td>${formattedDate}</td>
                        <td>${timeIn}</td>
                        <td>${timeOut}</td>
                        <td><span class="badge ${statusClass}">${status}</span></td>
                    </tr>
                `;
            }).join('');
        }
        
        window.exportToCSV = function() {
            const table = document.getElementById('reportTable');
            let csv = [];
            
            // Get headers
            const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.textContent);
            csv.push(headers.join(','));
            
            // Get rows
            const rows = table.querySelectorAll('tbody tr');
            rows.forEach(row => {
                const cols = Array.from(row.querySelectorAll('td')).map(td => {
                    // Remove badges and get text
                    return td.textContent.trim().replace(/,/g, ';');
                });
                if (cols.length > 1) {
                    csv.push(cols.join(','));
                }
            });
            
            // Download
            const csvContent = csv.join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `attendance-report-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        };
        
        // Initialize
        init();
    </script>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
