<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset Password - Student Portal</title>

    <!-- Bootstrap + icons (match login look) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">

    <style>
        :root{
            --brand: #0f172a;
            --anchor: var(--brand);
            --bg-page: #0f172a;
            --card-bg: #ffffff;
            --text-primary: var(--brand);
            --muted: rgba(15,23,42,0.65);
            --accent: #1e293b;
            --input-bg: #f8fafc;
            --input-border: rgba(15,23,42,0.08);
            --focus: rgba(14,165,233,0.12);
        }

        * { box-sizing: border-box; margin:0; padding:0; }
        html,body{ height:100%; }
        body{
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-page);
            color: var(--text-primary);
            -webkit-font-smoothing:antialiased;
            -moz-osx-font-smoothing:grayscale;
            display:flex;
            align-items:center;
            justify-content:center;
            padding:24px;
        }

        .container {
            width:100%;
            max-width:540px;
            background: var(--card-bg);
            border: 1px solid rgba(15,23,42,0.06);
            border-radius:14px;
            padding:28px;
            box-shadow: 0 10px 30px rgba(2,6,23,0.06);
        }

        .logo-section { text-align:center; margin-bottom:1rem; }
        .logo-icon{
            width:64px;
            height:64px;
            margin:0 auto 0.6rem;
            border-radius:50%;
            display:flex;
            align-items:center;
            justify-content:center;
            background: linear-gradient(135deg, rgba(14,165,233,0.05), rgba(30,41,59,0.03));
            color:var(--text-primary);
            font-size:1.25rem;
            border:1px solid rgba(15,23,42,0.04);
        }
        .logo-icon .bi{ font-size:1.4rem; }
        .title{ font-size:1.25rem; font-weight:700; color:var(--text-primary); margin-bottom:0.25rem; }
        .subtitle{ color:var(--muted); font-size:0.95rem; }

        /* replaced dot steps with three short horizontal bars */
        .step-indicator{
            width:100%;
            display:flex;
            gap:10px;
            justify-content:center;
            align-items:center;
            margin:14px 0 18px 0;
        }
        .step-bar{
            width:72px;
            height:8px;
            border-radius:8px;
            background: rgba(15,23,42,0.06);
            transition: background .18s ease, transform .12s ease;
            box-shadow: none;
        }
        .step-bar.active{
            background: var(--brand);
            box-shadow: 0 6px 18px rgba(15,23,42,0.06);
            transform: translateY(-1px);
        }

        /* keep legacy step elements for JS compatibility but hidden */
        .step-legacy{ display:none; }

        .form-section{ display:none; }
        .form-section.active{ display:block; }

        .form-group{ margin-bottom:1rem; }
        .form-label{ display:block; font-size:0.9rem; font-weight:600; color:var(--muted); margin-bottom:0.5rem; }
        .form-input{
            width:100%;
            padding:0.75rem 1rem;
            border-radius:10px;
            background:var(--input-bg);
            border:1px solid var(--input-border);
            color:var(--text-primary);
            font-size:0.95rem;
        }
        .form-input::placeholder{ color:rgba(15,23,42,0.34); }
        .form-input:focus{ outline:none; box-shadow:0 8px 28px var(--focus); border-color:rgba(15,23,42,0.14); background:#fff; }

        .btn {
            display:inline-block;
            padding:0.75rem 1rem;
            border-radius:10px;
            border:0;
            background: var(--brand);
            color:#ffffff;
            font-weight:700;
            cursor:pointer;
            text-align:center;
            width:100%;
        }
        .btn.btn-secondary{
            background: transparent;
            color: var(--text-primary);
            border: 2px solid rgba(15,23,42,0.06);
        }

        /* Keep primary button color and white text on hover/focus */
        .btn:hover, .btn:focus {
            background: var(--brand) !important;
            color: #ffffff !important;
            text-decoration: none;
            transform: translateY(-1px);
            box-shadow: 0 8px 24px rgba(2,6,23,0.08);
        }

        /* Secondary button subtle hover */
        .btn.btn-secondary:hover, .btn.btn-secondary:focus {
            background: rgba(15,23,42,0.02);
            color: var(--text-primary);
            border-color: rgba(15,23,42,0.10);
        }

        .back-link{ display:inline-block; margin-top:12px; color:var(--muted); text-decoration:none; font-size:0.95rem; }
        .back-link:hover{ color:var(--text-primary); text-decoration:underline; }

        /* OTP inputs */
        .otp-container{ display:flex; gap:8px; justify-content:center; margin-bottom:1rem; }
        .otp-input{
            width:44px; height:56px; text-align:center;
            font-size:1.15rem; border-radius:8px;
            border:1px solid var(--input-border); background:var(--input-bg);
            color:var(--text-primary);
        }

        .resend-link{ text-align:center; margin-top:8px; color:var(--muted); font-size:0.9rem; }
        .resend-link button{ background:none; border:0; color:var(--brand); font-weight:700; cursor:pointer; padding:0 6px; }

        .success-icon{
            width:72px; height:72px; border-radius:50%;
            display:flex; align-items:center; justify-content:center;
            background: rgba(16,185,129,0.09);
            color: #059669; margin:0 auto 1rem;
            font-size:1.6rem;
        }

        /* responsive */
        @media (max-width:480px){
            .container{ padding:18px; border-radius:12px; }
            .otp-input{ width:40px; height:52px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo-section">
            <div class="logo-icon" aria-hidden="true"><i class="bi bi-lock-fill"></i></div>
            <h1 class="title">Reset Password</h1>
            <p class="subtitle">Student Portal - Mabini High School</p>
        </div>

        <div class="step-indicator" aria-hidden="true">
            <div class="step-bar" id="step-bar-1" role="progressbar" aria-label="Step 1" aria-valuenow="1"></div>
            <div class="step-bar" id="step-bar-2" role="progressbar" aria-label="Step 2" aria-valuenow="2"></div>
            <div class="step-bar" id="step-bar-3" role="progressbar" aria-label="Step 3" aria-valuenow="3"></div>

            <!-- legacy step elements kept for compatibility with existing JS (hidden) -->
            <div class="step-legacy" aria-hidden="true">
                <div id="step1" class="step active"></div>
                <div id="step2" class="step"></div>
                <div id="step3" class="step"></div>
            </div>
        </div>

        <div id="alert-container" aria-live="polite"></div>

        <!-- Step 1: Enter Email -->
        <div id="email-section" class="form-section active">
            <p class="subtitle" style="margin-bottom: 1.25rem;">Enter your email address to receive a 6-digit OTP code for password reset.</p>
            <form id="email-form">
                <div class="form-group">
                    <label class="form-label" for="email">Email Address</label>
                    <input type="email" id="email" class="form-input" placeholder="student@mabini.edu" required>
                </div>
                <button type="submit" class="btn" id="send-otp-btn">Send OTP Code</button>
                <a href="login.html" class="back-link">Back to Login</a>
            </form>
        </div>

        <!-- Step 2: Verify OTP -->
        <div id="otp-section" class="form-section">
            <p class="subtitle" style="margin-bottom: 1rem;">We've sent a 6-digit code to <strong id="email-display"></strong></p>
            <form id="otp-form">
                <div class="otp-container">
                    <input type="text" class="otp-input" maxlength="1" pattern="[0-9]" inputmode="numeric" id="otp1" autocomplete="one-time-code" required aria-label="OTP digit 1">
                    <input type="text" class="otp-input" maxlength="1" pattern="[0-9]" inputmode="numeric" id="otp2" required aria-label="OTP digit 2">
                    <input type="text" class="otp-input" maxlength="1" pattern="[0-9]" inputmode="numeric" id="otp3" required aria-label="OTP digit 3">
                    <input type="text" class="otp-input" maxlength="1" pattern="[0-9]" inputmode="numeric" id="otp4" required aria-label="OTP digit 4">
                    <input type="text" class="otp-input" maxlength="1" pattern="[0-9]" inputmode="numeric" id="otp5" required aria-label="OTP digit 5">
                    <input type="text" class="otp-input" maxlength="1" pattern="[0-9]" inputmode="numeric" id="otp6" required aria-label="OTP digit 6">
                </div>
                <button type="submit" class="btn" id="verify-otp-btn">Verify OTP</button>
                <div class="resend-link" style="margin-top:12px;">
                    Didn't receive the code?
                    <button type="button" id="resend-btn" aria-disabled="false">Resend OTP</button>
                    <span id="timer" aria-live="polite"></span>
                </div>
                <button type="button" class="btn btn-secondary" id="change-email-btn" style="margin-top:12px;">Change Email</button>
            </form>
        </div>

        <!-- Step 3: Reset Password -->
        <div id="password-section" class="form-section">
            <p class="subtitle" style="margin-bottom: 1.25rem;">Create a new password for your account.</p>
            <form id="password-form">
                <div class="form-group">
                    <label class="form-label" for="new-password">New Password</label>
                    <input type="password" id="new-password" class="form-input" placeholder="Enter new password" minlength="6" required>
                    <small style="color: var(--muted); font-size: 0.85rem;">Must be at least 6 characters</small>
                </div>
                <div class="form-group">
                    <label class="form-label" for="confirm-password">Confirm Password</label>
                    <input type="password" id="confirm-password" class="form-input" placeholder="Re-enter new password" required>
                </div>
                <button type="submit" class="btn" id="reset-password-btn">Reset Password</button>
            </form>
        </div>

        <!-- Step 4: Success -->
        <div id="success-section" class="form-section">
            <div class="success-icon" aria-hidden="true"><i class="bi bi-check-circle-fill"></i></div>
            <h2 style="text-align: center; color: #059669; margin-bottom: 1rem;">Password Reset Complete!</h2>
            <p class="subtitle" style="text-align: center; margin-bottom: 1.25rem;">
                Your password has been successfully reset. 
                <strong>You can now login with your new password.</strong>
            </p>
            <p class="subtitle" style="text-align: center; margin-bottom: 1.25rem; font-size: 0.85rem;">
                Email: <strong id="reset-email-display"></strong><br>
                Status: Password Updated
            </p>
            <a href="login.html" class="btn" style="text-decoration: none; display:block; text-align:center;">Go to Login</a>
        </div>
    </div>

    <script type="module">
        import { initForgotPassword } from '../shared/js/forgot-password.js';
        initForgotPassword({ role: 'student', portalLabel: 'Student Portal', loginUrl: 'login.html' });
    </script>

    <script>
        // sync three short bars with legacy step nodes (keeps compatibility)
        (function(){
            const bars = [
                document.getElementById('step-bar-1'),
                document.getElementById('step-bar-2'),
                document.getElementById('step-bar-3')
            ];
            function updateBars(){
                const s1 = document.getElementById('step1');
                const s2 = document.getElementById('step2');
                const s3 = document.getElementById('step3');
                if (!bars[0]) return;
                // reset
                bars.forEach(b => b.classList.remove('active'));
                if (s3 && s3.classList.contains('active')) {
                    bars[0].classList.add('active');
                    bars[1].classList.add('active');
                    bars[2].classList.add('active');
                } else if (s2 && s2.classList.contains('active')) {
                    bars[0].classList.add('active');
                    bars[1].classList.add('active');
                } else {
                    bars[0].classList.add('active');
                }
                // update aria-current for accessibility
                bars.forEach((b, i) => b.setAttribute('aria-current', b.classList.contains('active') ? 'true' : 'false'));
            }

            // initial sync
            updateBars();

            // observe legacy step nodes for class changes
            const legacy = document.querySelector('.step-legacy');
            if (legacy) {
                const observer = new MutationObserver(updateBars);
                observer.observe(legacy, { attributes: true, subtree: true, attributeFilter: ['class'] });
            }

            // also listen for custom events if shared module emits them
            document.addEventListener('forgot-password-step', updateBars, { passive: true });
        })();
    </script>
</body>
</html>
