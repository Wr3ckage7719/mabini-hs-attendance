<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings - Student Portal</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../assets/css/dashboard.css">
    <script src="../assets/js/theme.js" defer></script>
    <!-- Icons removed as requested -->
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f6f8ff 0%, #f0f3ff 100%); /* light mode */
            min-height: 100vh;
            color: #2d3748;
            transition: background 0.3s ease, color 0.3s ease;
        }
        
        html[data-theme='dark'] body {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); /* dark mode */
            color: #e2e8f0;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.95); /* light mode */
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.3s ease, border-color 0.3s ease;
        }
        
        html[data-theme='dark'] .header {
            background: rgba(15, 23, 42, 0.95); /* dark mode */
            border-bottom: 1px solid rgba(148, 163, 184, 0.1);
        }
        
        .header-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: #111827; /* light mode */
            transition: color 0.3s ease;
        }
        
        html[data-theme='dark'] .header-title {
            color: white; /* dark mode */
        }
        
        .header-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        
        .btn-link {
            color: #60a5fa;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s;
        }
        
        .btn-link:hover { color: #93c5fd; }

        /* Plain text action style for header links like 'Log in' */
        .text-action {
            color: #60a5fa;
            text-decoration: none;
            font-weight: 600;
            transition: color 0.25s, transform 0.18s;
            cursor: pointer;
            padding: 0.15rem 0.25rem;
            border-radius: 6px;
            display: inline-block;
        }

        .text-action:hover {
            color: #93c5fd;
            transform: translateY(-2px);
        }
        
        .btn-logout {
            background: #dc2626;
            color: white;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-logout:hover {
            background: #b91c1c;
            transform: translateY(-1px);
        }
        
        .container {
            max-width: 900px;
            margin: 2rem auto;
            padding: 0 1.5rem;
        }
        
        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            color: #60a5fa;
            text-decoration: none;
            font-weight: 600;
            margin-bottom: 2rem;
            transition: gap 0.3s;
        }
        
        .back-link:hover { gap: 0.75rem; }
        
        .settings-section {
            background: rgba(30, 41, 59, 0.6);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(148, 163, 184, 0.1);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
        }
        
        .section-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            color: #111827; /* light mode */
            transition: color 0.3s ease;
        }
        
        html[data-theme='dark'] .section-title {
            color: white; /* dark mode */
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-label {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #475569; /* light mode */
            font-size: 0.875rem;
            transition: color 0.3s ease;
        }
        
        html[data-theme='dark'] .form-label {
            color: #cbd5e1; /* dark mode */
        }
        
        .form-description {
            font-size: 0.75rem;
            color: #64748b; /* light mode */
            margin-bottom: 0.5rem;
            transition: color 0.3s ease;
        }
        
        html[data-theme='dark'] .form-description {
            color: #94a3b8; /* dark mode */
        }
        
        .form-input, .form-select {
            width: 100%;
            padding: 0.75rem 1rem;
            background: #ffffff; /* light mode */
            border: 2px solid rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            color: #111827;
            font-size: 0.95rem;
            transition: all 0.3s;
        }
        
        html[data-theme='dark'] .form-input,
        html[data-theme='dark'] .form-select {
            background: rgba(15, 23, 42, 0.8); /* dark mode */
            border: 2px solid rgba(148, 163, 184, 0.2);
            color: white;
        }
        
        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #60a5fa;
        }
        
        html[data-theme='dark'] .form-input:focus,
        html[data-theme='dark'] .form-select:focus {
            background: rgba(15, 23, 42, 0.95);
        }
        
        .form-input:read-only {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #001f5b 0%, #00306e 100%);
            color: white;
            padding: 0.875rem 2rem;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 31, 91, 0.3);
        }
        
        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-secondary {
            background: rgba(100, 116, 139, 0.3);
            color: white;
            padding: 0.875rem 2rem;
            border: 2px solid rgba(148, 163, 184, 0.3);
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-left: 1rem;
        }
        
        .btn-secondary:hover {
            background: rgba(100, 116, 139, 0.5);
            border-color: rgba(148, 163, 184, 0.5);
        }
        
        .alert {
            padding: 1rem 1.25rem;
            border-radius: 10px;
            margin-bottom: 1.5rem;
            animation: slideDown 0.3s ease-out;
        }
        
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .alert-success {
            background: rgba(16, 185, 129, 0.2);
            border: 1px solid rgba(16, 185, 129, 0.4);
            color: #6ee7b7;
        }
        
        .alert-error {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.4);
            color: #fca5a5;
        }
        
        .btn-group {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
        }
        
        textarea.form-input {
            min-height: 100px;
            resize: vertical;
            font-family: inherit;
        }
        
        .settings-section {
            background: #ffffff; /* light mode */
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            transition: all 0.3s ease;
        }
        
        html[data-theme='dark'] .settings-section {
            background: rgba(15, 23, 42, 0.6); /* dark mode */
            border: 1px solid rgba(148, 163, 184, 0.1);
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-title">STUDENT SETTINGS</div>
        <div class="header-actions">
            <div id="themeToggle" class="theme-toggle-wrap" style="display:inline-flex; align-items:center; margin-right:0.6rem;">
                <label class="toggle-switch" style="display:inline-flex; align-items:center; cursor:pointer;">
                    <input id="themeToggleInput" type="checkbox" role="switch" aria-label="Toggle theme" style="display:none;">
                    <span class="switch-track" style="width:44px; height:24px; display:inline-block; border-radius:999px; padding:2px; box-sizing:content-box; background:#e5e7eb;">
                        <span class="switch-thumb" style="display:inline-block; width:20px; height:20px; background:#fff; border-radius:50%; transition:transform .18s ease; box-shadow:0 1px 2px rgba(0,0,0,0.1); transform:translateX(0);"></span>
                    </span>
                </label>
            </div>
            <a class="text-action" href="dashboard.html">Back to Dashboard</a>
        </div>
    </div>

    <div class="container">
        <div id="alert-container"></div>

        <form id="profile-form">
            <!-- Account Settings -->
            <div class="settings-section">
                <h2 class="section-title">Account Settings</h2>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Full Name *</label>
                        <div class="form-description">Your full name as displayed in the system</div>
                        <input type="text" id="fullName" class="form-input" placeholder="Enter full name" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Email Address</label>
                        <div class="form-description">Your email for notifications and login</div>
                        <input type="email" id="email" class="form-input" readonly>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Profile Photo</label>
                        <div class="form-description">Upload a profile picture (optional). Preview will show after selection.</div>
                        <div style="display:flex;gap:1rem;align-items:center;">
                            <img id="photoPreview" src="" alt="Profile preview" style="width:80px;height:80px;border-radius:50%;object-fit:cover;display:none;border:2px solid rgba(148,163,184,0.15);" />
                            <div style="display:flex;flex-direction:column;gap:0.5rem;flex:1;">
                                <input type="file" id="photoInput" accept="image/*" class="form-input" style="padding:0.35rem;"/>
                                <button type="button" id="removePhotoBtn" class="btn-secondary" style="width:fit-content;">Remove Photo</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Student Number</label>
                        <div class="form-description">Assigned by administrator</div>
                        <input type="text" id="studentId" class="form-input" readonly>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Grade Level</label>
                        <div class="form-description">Assigned by administrator</div>
                        <input type="text" id="gradeLevel" class="form-input" readonly>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Section</label>
                        <div class="form-description">Assigned by administrator</div>
                        <input type="text" id="section" class="form-input" readonly>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Strand (for SHS)</label>
                        <div class="form-description">Assigned by administrator</div>
                        <input type="text" id="strand" class="form-input" readonly>
                    </div>
                </div>
            </div>

            <!-- Contact Information -->
            <div class="settings-section">
                <h2 class="section-title">Contact Information</h2>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Phone Number</label>
                        <div class="form-description">Your contact number</div>
                        <input type="tel" id="phone" class="form-input" placeholder="09XXXXXXXXX">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Contact Email</label>
                        <div class="form-description">Alternative contact email</div>
                        <input type="email" id="contactEmail" class="form-input" placeholder="your.email@example.com">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Address</label>
                    <div class="form-description">Your complete address</div>
                    <textarea id="address" class="form-input" placeholder="Enter your address"></textarea>
                </div>
            </div>

            <!-- Personal Information -->
            <div class="settings-section">
                <h2 class="section-title">Personal Information</h2>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Sex</label>
                        <select id="sex" class="form-select">
                            <option value="">Select</option>
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Nationality</label>
                        <input type="text" id="nationality" class="form-input" placeholder="e.g., Filipino">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Birth Date</label>
                        <input type="date" id="birthDate" class="form-input">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Birth Place</label>
                        <input type="text" id="birthPlace" class="form-input" placeholder="City, Province">
                    </div>
                </div>
            </div>

            <!-- Save Buttons -->
            <div class="btn-group">
                <button type="submit" class="btn-primary" id="save-btn">
                    Save Changes
                </button>
            </div>
        </form>
    </div>

    <script type="module">
        import { authClient } from '../js/auth-client.js';
        import { dataClient } from '../js/data-client.js';

        let userData = null;
        let currentStudent = null;

        // Check authentication via sessionStorage (student login)
        const studentData = sessionStorage.getItem('studentData');
        const userRole = sessionStorage.getItem('userRole');
        
        if (!studentData || userRole !== 'student') {
            window.location.href = 'login.html';
            throw new Error('Not authenticated');
        }
        
        const student = JSON.parse(studentData);
        currentStudent = student;
        
        // Set userData for compatibility with existing code
        userData = { email: student.email };
        console.log('Current student:', currentStudent);

        // Load profile data
        async function loadProfile() {
            try {
                // Find student by ID from session
                const studentResult = await dataClient.query('students', {
                    filter: { id: currentStudent.id },
                    single: true
                });

                console.log('Load profile result:', studentResult);
                
                const profile = studentResult;
                if (profile) {
                    currentStudent = profile;
                    
                    // Populate form fields
                    document.getElementById('fullName').value = profile.full_name || profile.fullName || (profile.first_name + ' ' + profile.last_name) || '';
                    document.getElementById('email').value = profile.email || '';
                    document.getElementById('studentId').value = profile.student_id || profile.studentId || '';
                    document.getElementById('gradeLevel').value = profile.grade_level || profile.gradeLevel || '';
                    document.getElementById('section').value = profile.section || '';
                    document.getElementById('strand').value = profile.strand || '';
                    document.getElementById('phone').value = profile.phone || '';
                    document.getElementById('contactEmail').value = profile.contact_email || profile.contactEmail || '';
                    document.getElementById('address').value = profile.address || '';
                    document.getElementById('sex').value = profile.sex || '';
                    document.getElementById('nationality').value = profile.nationality || '';
                    document.getElementById('birthDate').value = profile.birth_date || profile.birthDate || '';
                    document.getElementById('birthPlace').value = profile.birth_place || profile.birthPlace || '';
                    // Load profile photo if present
                    if (profile.profile_photo) {
                        profilePhotoBase64 = profile.profile_photo;
                        photoPreview.src = profilePhotoBase64;
                        photoPreview.style.display = 'block';
                    } else {
                        profilePhotoBase64 = null;
                        photoPreview.src = '';
                        photoPreview.style.display = 'none';
                    }
                } else {
                    console.error('Failed to load profile');
                    showAlert('Failed to load profile: Student not found', 'error');
                }
            } catch (error) {
                console.error('Load profile error:', error);
                showAlert('Failed to load profile data', 'error');
            }
        }

        // Save profile
        document.getElementById('profile-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const saveBtn = document.getElementById('save-btn');
            saveBtn.disabled = true;
            saveBtn.textContent = 'Saving...';

            try {
                const profileData = {
                    full_name: document.getElementById('fullName').value.trim(),
                    phone: document.getElementById('phone').value.trim(),
                    contact_email: document.getElementById('contactEmail').value.trim(),
                    address: document.getElementById('address').value.trim(),
                    sex: document.getElementById('sex').value,
                    nationality: document.getElementById('nationality').value.trim(),
                    birth_date: document.getElementById('birthDate').value,
                    birth_place: document.getElementById('birthPlace').value.trim(),
                    updated_at: new Date().toISOString(),
                    profile_photo: profilePhotoBase64
                };

                await dataClient.update('students', currentStudent.id, profileData);
                console.log('Update complete');

                showAlert('Profile updated successfully!', 'success');
                
                // Reload profile to show updated data
                setTimeout(() => loadProfile(), 1000);
            } catch (error) {
                console.error('Save error:', error);
                showAlert('Failed to save changes. Please try again.', 'error');
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = 'Save Changes';
            }
        });

        // Show alert
        function showAlert(message, type = 'success') {
            const alertContainer = document.getElementById('alert-container');
            alertContainer.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => alertContainer.innerHTML = '', 5000);
        }

        // Logout
        window.doLogout = async function() {
            if (confirm('Are you sure you want to logout?')) {
                await authClient.logout();
                window.location.href = 'login.html';
            }
        };

        // Profile photo data (base64)
        let profilePhotoBase64 = null;

        // Handle photo input
        const photoInput = document.getElementById('photoInput');
        const photoPreview = document.getElementById('photoPreview');
        const removePhotoBtn = document.getElementById('removePhotoBtn');

        photoInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(evt) {
                profilePhotoBase64 = evt.target.result;
                photoPreview.src = profilePhotoBase64;
                photoPreview.style.display = 'block';
            };
            reader.readAsDataURL(file);
        });

        removePhotoBtn.addEventListener('click', () => {
            profilePhotoBase64 = null;
            photoPreview.src = '';
            photoPreview.style.display = 'none';
            photoInput.value = '';
        });

        // Load profile on page load
        loadProfile();
    </script>
</body>
</html>
