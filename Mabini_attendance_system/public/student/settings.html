<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings - Student Portal</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script>(function(){const t=localStorage.getItem('theme'),p=window.matchMedia('(prefers-color-scheme: dark)').matches,theme=t||(p?'dark':'light');document.documentElement.setAttribute('data-theme',theme);document.documentElement.setAttribute('data-bs-theme',theme);})();</script>
    <link rel="stylesheet" href="../assets/css/dashboard.css">
    <script src="../assets/js/theme.js" defer></script>
    <!-- Icons removed as requested -->
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f6f8ff 0%, #f0f3ff 100%); /* light mode */
            min-height: 100vh;
            color: #2d3748;
            transition: background 0.3s ease, color 0.3s ease;
        }
        
        html[data-theme='dark'] body {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); /* dark mode */
            color: #e2e8f0;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.95); /* light mode */
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.3s ease, border-color 0.3s ease;
        }
        
        html[data-theme='dark'] .header {
            background: rgba(15, 23, 42, 0.95); /* dark mode */
            border-bottom: 1px solid rgba(148, 163, 184, 0.1);
        }
        
        .header-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: #111827; /* light mode */
            transition: color 0.3s ease;
        }
        
        html[data-theme='dark'] .header-title {
            color: white; /* dark mode */
        }
        
        .header-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        
        .btn-link {
            color: #60a5fa;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s;
        }
        
        .btn-link:hover { color: #93c5fd; }

        /* Plain text action style for header links like 'Log in' */
        .text-action {
            color: #60a5fa;
            text-decoration: none;
            font-weight: 600;
            transition: color 0.25s, transform 0.18s;
            cursor: pointer;
            padding: 0.15rem 0.25rem;
            border-radius: 6px;
            display: inline-block;
        }

        .text-action:hover {
            color: #93c5fd;
            transform: translateY(-2px);
        }
        
        .btn-logout {
            background: #dc2626;
            color: white;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-logout:hover {
            background: #b91c1c;
            transform: translateY(-1px);
        }
        
        .container {
            max-width: 900px;
            margin: 2rem auto;
            padding: 0 1.5rem;
        }
        
        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            color: #60a5fa;
            text-decoration: none;
            font-weight: 600;
            margin-bottom: 2rem;
            transition: gap 0.3s;
        }
        
        .back-link:hover { gap: 0.75rem; }
        
        .settings-section {
            background: rgba(30, 41, 59, 0.6);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(148, 163, 184, 0.1);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
        }
        
        .section-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            color: #111827; /* light mode */
            transition: color 0.3s ease;
        }
        
        html[data-theme='dark'] .section-title {
            color: white; /* dark mode */
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-label {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #475569; /* light mode */
            font-size: 0.875rem;
            transition: color 0.3s ease;
        }
        
        html[data-theme='dark'] .form-label {
            color: #cbd5e1; /* dark mode */
        }
        
        .form-description {
            font-size: 0.75rem;
            color: #64748b; /* light mode */
            margin-bottom: 0.5rem;
            transition: color 0.3s ease;
        }
        
        html[data-theme='dark'] .form-description {
            color: #94a3b8; /* dark mode */
        }
        
        .form-input, .form-select {
            width: 100%;
            padding: 0.75rem 1rem;
            background: #ffffff; /* light mode */
            border: 2px solid rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            color: #111827;
            font-size: 0.95rem;
            transition: all 0.3s;
        }
        
        html[data-theme='dark'] .form-input,
        html[data-theme='dark'] .form-select {
            background: rgba(15, 23, 42, 0.8); /* dark mode */
            border: 2px solid rgba(148, 163, 184, 0.2);
            color: white;
        }
        
        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #60a5fa;
        }
        
        html[data-theme='dark'] .form-input:focus,
        html[data-theme='dark'] .form-select:focus {
            background: rgba(15, 23, 42, 0.95);
        }
        
        .form-input:read-only {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #001f5b 0%, #00306e 100%);
            color: white;
            padding: 0.875rem 2rem;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 31, 91, 0.3);
        }
        
        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-secondary {
            background: rgba(100, 116, 139, 0.3);
            color: white;
            padding: 0.875rem 2rem;
            border: 2px solid rgba(148, 163, 184, 0.3);
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-left: 1rem;
        }
        
        .btn-secondary:hover {
            background: rgba(100, 116, 139, 0.5);
            border-color: rgba(148, 163, 184, 0.5);
        }
        
        .alert {
            padding: 1rem 1.25rem;
            border-radius: 10px;
            margin-bottom: 1.5rem;
            animation: slideDown 0.3s ease-out;
        }
        
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .alert-success {
            background: rgba(16, 185, 129, 0.2);
            border: 1px solid rgba(16, 185, 129, 0.4);
            color: #6ee7b7;
        }
        
        .alert-error {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.4);
            color: #fca5a5;
        }
        
        .btn-group {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
        }
        
        textarea.form-input {
            min-height: 100px;
            resize: vertical;
            font-family: inherit;
        }
        
        .settings-section {
            background: #ffffff; /* light mode */
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            transition: all 0.3s ease;
        }
        
        html[data-theme='dark'] .settings-section {
            background: rgba(15, 23, 42, 0.6); /* dark mode */
            border: 1px solid rgba(148, 163, 184, 0.1);
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-title">STUDENT SETTINGS</div>
        <div class="header-actions">
            <div id="themeToggle" class="theme-toggle-wrap" style="display:inline-flex; align-items:center; margin-right:0.6rem;">
                <label class="toggle-switch" style="display:inline-flex; align-items:center; cursor:pointer;">
                    <input id="themeToggleInput" type="checkbox" role="switch" aria-label="Toggle theme" style="display:none;">
                    <span class="switch-track" style="width:44px; height:24px; display:inline-block; border-radius:999px; padding:2px; box-sizing:content-box; background:#e5e7eb;">
                        <span class="switch-thumb" style="display:inline-block; width:20px; height:20px; background:#fff; border-radius:50%; transition:transform .18s ease; box-shadow:0 1px 2px rgba(0,0,0,0.1); transform:translateX(0);"></span>
                    </span>
                </label>
            </div>
            <a class="text-action" href="dashboard.html">Back to Dashboard</a>
        </div>
    </div>

    <div class="container">
        <div id="alert-container"></div>

        <form id="profile-form">
            <!-- Account Settings -->
            <div class="settings-section">
                <h2 class="section-title">Account Settings</h2>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Full Name *</label>
                        <div class="form-description">Your full name as displayed in the system</div>
                        <input type="text" id="fullName" class="form-input" placeholder="Enter full name" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Email Address</label>
                        <div class="form-description">Your email for notifications and login</div>
                        <input type="email" id="email" class="form-input" readonly>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Profile Photo</label>
                        <div class="form-description">Upload a profile picture (optional). Preview will show after selection.</div>
                        <div style="display:flex;gap:1rem;align-items:center;">
                            <img id="photoPreview" src="../assets/img/default-avatar.png" alt="Profile preview" style="width:80px;height:80px;border-radius:50%;object-fit:cover;border:2px solid rgba(148,163,184,0.15);" />
                            <div style="display:flex;flex-direction:column;gap:0.5rem;flex:1;">
                                <input type="file" id="photoInput" accept="image/*" class="form-input" style="padding:0.35rem;"/>
                                <button type="button" id="removePhotoBtn" class="btn-secondary" style="width:fit-content;">Remove Photo</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Your QR Code</label>
                        <div class="form-description">Scan this QR code to login quickly</div>
                        <div style="display:flex;gap:1rem;align-items:center;">
                            <img id="qrPreview" src="../assets/img/default-qr.png" alt="QR Code" style="width:150px;height:150px;border-radius:8px;object-fit:contain;border:2px solid rgba(148,163,184,0.15);background:white;padding:8px;" />
                            <div style="display:flex;flex-direction:column;gap:0.5rem;">
                                <button type="button" id="downloadQRBtn" class="btn-secondary">Download QR Code</button>
                                <small style="color:#94a3b8;">Use this QR code on your ID card for quick login</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Contact Information -->
            <div class="settings-section">
                <h2 class="section-title">Contact Information</h2>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Phone Number</label>
                        <div class="form-description">Your contact number</div>
                        <input type="tel" id="phone" class="form-input" placeholder="09XXXXXXXXX">
                    </div>
                </div>
            </div>

            <!-- Save Buttons -->
            <div class="btn-group">
                <button type="submit" class="btn-primary" id="save-btn">
                    Save Changes
                </button>
            </div>
        </form>

        <!-- Change Password Section -->
        <form id="password-form">
            <div class="settings-section">
                <h2 class="section-title">Change Password</h2>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Current Password</label>
                        <input type="password" id="currentPassword" class="form-input" placeholder="Enter your current password">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">New Password</label>
                        <input type="password" id="newPassword" class="form-input" placeholder="Enter your new password">
                        <div class="form-description">Password must be at least 8 characters, include uppercase, lowercase and a number.</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Confirm New Password</label>
                        <input type="password" id="confirmNewPassword" class="form-input" placeholder="Re-enter your new password">
                    </div>
                </div>

                <div style="margin-top:1rem; display:flex; gap:1rem; align-items:center; flex-wrap: wrap;">
                    <button type="button" id="changePasswordBtn" class="btn-primary">Update Password</button>
                    <div id="changePasswordStatus" style="color:#cbd5e1; font-size:0.95rem;"></div>
                </div>
            </div>
        </form>
    </div>

    <!-- Password Change Prompt Modal -->
    <div id="passwordPromptModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:9999; align-items:center; justify-content:center;">
        <div style="background:white; padding:2rem; border-radius:16px; max-width:500px; width:90%; box-shadow:0 20px 50px rgba(0,0,0,0.3);">
            <h2 style="color:#111827; margin-bottom:1rem; font-size:1.5rem;">Welcome! Please Change Your Password</h2>
            <p style="color:#64748b; margin-bottom:1.5rem; line-height:1.6;">
                For your security, we recommend changing your password after retrieving your account. 
                Please go to Settings to update your password.
            </p>
            <div style="display:flex; gap:1rem; justify-content:flex-end;">
                <button id="remindLaterBtn" style="background:#94a3b8; color:white; padding:0.75rem 1.5rem; border:none; border-radius:8px; font-weight:600; cursor:pointer;">
                    Remind Me Later
                </button>
                <button id="goToSettingsBtn" style="background:#001f5b; color:white; padding:0.75rem 1.5rem; border:none; border-radius:8px; font-weight:600; cursor:pointer;">
                    Go to Settings
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import { authClient } from '../js/auth-client.js';
        import { dataClient } from '../js/data-client.js';
        import { storageClient } from '../js/storage-client.js';

        let userData = null;
        let currentStudent = null;
        let profilePhotoFile = null;

        // Check authentication via sessionStorage (student login)
        const studentData = sessionStorage.getItem('studentData');
        const userRole = sessionStorage.getItem('userRole');
        
        if (!studentData || userRole !== 'student') {
            window.location.href = 'login.html';
            throw new Error('Not authenticated');
        }
        
        const student = JSON.parse(studentData);
        currentStudent = student;
        
        // Set userData for compatibility with existing code
        userData = { email: student.email };
        console.log('Current student:', currentStudent);

        // Load profile data
        async function loadProfile() {
            try {
                // Find student by ID from session using getOne method
                const studentResult = await dataClient.getOne('students', currentStudent.id);

                console.log('Load profile result:', studentResult);
                
                if (studentResult.error) {
                    console.error('Error loading profile:', studentResult.error);
                    showAlert('Failed to load profile: ' + studentResult.error, 'error');
                    return;
                }
                
                const profile = studentResult.data;
                if (profile) {
                    currentStudent = profile;
                    
                    // Populate form fields - use actual database columns
                    // Combine first_name and last_name for display
                    const fullName = `${profile.first_name || ''} ${profile.last_name || ''}`.trim();
                    document.getElementById('fullName').value = fullName;
                    document.getElementById('email').value = profile.email || '';
                    document.getElementById('phone').value = profile.parent_guardian_contact || profile.emergency_contact || '';
                    
                    // Load profile photo from Storage URL or fallback to base64
                    const photoUrl = storageClient.getImageUrl(profile, 'profile_picture', '../assets/img/default-avatar.png');
                    document.getElementById('photoPreview').src = photoUrl;
                    
                    // Load QR code from Storage URL or fallback to base64
                    const qrUrl = storageClient.getImageUrl(profile, 'qr_code', '../assets/img/default-qr.png');
                    document.getElementById('qrPreview').src = qrUrl;
                    
                    // Show download button only if QR exists
                    const downloadBtn = document.getElementById('downloadQRBtn');
                    if (profile.qr_code_url || profile.qr_code) {
                        downloadBtn.style.display = 'inline-block';
                        downloadBtn.onclick = () => downloadQRCode(qrUrl, profile.student_number);
                    } else {
                        downloadBtn.style.display = 'none';
                    }
                } else {
                    console.error('Failed to load profile');
                    showAlert('Failed to load profile: Student not found', 'error');
                }
            } catch (error) {
                console.error('Load profile error:', error);
                showAlert('Failed to load profile data', 'error');
            }
        }
        
        // Download QR code
        function downloadQRCode(imageUrl, studentNumber) {
            const link = document.createElement('a');
            link.href = imageUrl;
            link.download = `${studentNumber}-qr-code.png`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Save profile
        document.getElementById('profile-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const saveBtn = document.getElementById('save-btn');
            saveBtn.disabled = true;
            saveBtn.textContent = 'Saving...';

            try {
                // Split full name into first and last name
                const fullName = document.getElementById('fullName').value.trim();
                const nameParts = fullName.split(' ');
                const firstName = nameParts[0] || '';
                const lastName = nameParts.slice(1).join(' ') || '';
                
                const profileData = {
                    first_name: firstName,
                    last_name: lastName,
                    parent_guardian_contact: document.getElementById('phone').value.trim() || null
                };
                
                // Upload profile picture to Supabase Storage if file selected
                if (profilePhotoFile) {
                    try {
                        const profileUrl = await storageClient.uploadProfilePicture(profilePhotoFile, currentStudent.student_number);
                        profileData.profile_picture_url = profileUrl;
                        console.log('Profile picture uploaded:', profileUrl);
                    } catch (uploadError) {
                        console.warn('Profile upload failed, skipping:', uploadError);
                        showAlert('Warning: Profile picture upload failed, but other changes will be saved', 'warning');
                    }
                }

                console.log('Updating student profile:', currentStudent.id, profileData);
                const result = await dataClient.update('students', currentStudent.id, profileData);
                console.log('Update result:', result);

                if (result.error) {
                    throw new Error(result.error);
                }

                showAlert('Profile updated successfully!', 'success');
                
                // Update session storage with new data
                currentStudent = { ...currentStudent, ...result.data };
                sessionStorage.setItem('studentData', JSON.stringify(currentStudent));
                
                // Clear file input and reload profile to show updated data
                profilePhotoFile = null;
                setTimeout(() => loadProfile(), 1000);
            } catch (error) {
                console.error('Save error:', error);
                showAlert('Failed to save changes: ' + (error.message || 'Unknown error'), 'error');
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = 'Save Changes';
            }
        });

        // Show alert
        function showAlert(message, type = 'success') {
            const alertContainer = document.getElementById('alert-container');
            alertContainer.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => alertContainer.innerHTML = '', 5000);
        }

        // Logout
        window.doLogout = async function() {
            if (confirm('Are you sure you want to logout?')) {
                await authClient.logout();
                window.location.href = 'login.html';
            }
        };

        // Handle photo input - must be after DOM is ready
        const photoInput = document.getElementById('photoInput');
        const photoPreview = document.getElementById('photoPreview');
        const removePhotoBtn = document.getElementById('removePhotoBtn');

        photoInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            // Validate file type
            if (!file.type.match('image.*')) {
                showAlert('Please select an image file (PNG, JPG, JPEG)', 'error');
                photoInput.value = '';
                return;
            }
            
            // Validate file size (5MB max)
            if (file.size > 5 * 1024 * 1024) {
                showAlert('File size must be less than 5MB', 'error');
                photoInput.value = '';
                return;
            }
            
            // Store file for upload on save
            profilePhotoFile = file;
            
            // Show preview
            const reader = new FileReader();
            reader.onload = function(evt) {
                photoPreview.src = evt.target.result;
            };
            reader.readAsDataURL(file);
        });

        removePhotoBtn.addEventListener('click', async () => {
            if (!confirm('Remove your profile picture?')) return;
            
            // Clear preview and file
            profilePhotoFile = null;
            photoPreview.src = '../assets/img/default-avatar.png';
            photoInput.value = '';
            
            // Delete from Storage if exists
            if (currentStudent.profile_picture_url) {
                try {
                    await storageClient.deleteImage(currentStudent.profile_picture_url);
                    
                    // Update database to remove URL
                    await dataClient.update('students', currentStudent.id, {
                        profile_picture_url: null
                    });
                    
                    currentStudent.profile_picture_url = null;
                    showAlert('Profile picture removed successfully', 'success');
                } catch (error) {
                    console.error('Error removing profile picture:', error);
                    showAlert('Failed to remove profile picture', 'error');
                }
            }
        });

        // Change Password handler
        document.getElementById('changePasswordBtn').addEventListener('click', async () => {
            const current = document.getElementById('currentPassword').value.trim();
            const next = document.getElementById('newPassword').value.trim();
            const confirm = document.getElementById('confirmNewPassword').value.trim();
            const statusEl = document.getElementById('changePasswordStatus');

            function showLocalError(msg) {
                statusEl.textContent = msg;
                statusEl.style.color = '#fca5a5';
                setTimeout(() => statusEl.textContent = '', 5000);
            }

            // Basic client-side validation
            if (!current) return showLocalError('Enter your current password');
            if (!next) return showLocalError('Enter a new password');
            if (next !== confirm) return showLocalError('New passwords do not match');
            if (next.length < 8) return showLocalError('Password must be at least 8 characters');
            if (!/[A-Z]/.test(next)) return showLocalError('Include at least one uppercase letter');
            if (!/[a-z]/.test(next)) return showLocalError('Include at least one lowercase letter');
            if (!/[0-9]/.test(next)) return showLocalError('Include at least one number');

            // Verify current password matches stored password
            if (currentStudent.password !== current) {
                return showLocalError('Current password is incorrect');
            }

            const btn = document.getElementById('changePasswordBtn');
            btn.disabled = true;
            const prevText = btn.textContent;
            btn.textContent = 'Updating...';

            try {
                // Update password in database
                const result = await dataClient.update('students', currentStudent.id, {
                    password: next
                });

                if (result.error) {
                    throw new Error(result.error);
                }

                showAlert('Password updated successfully!', 'success');
                
                // Update session storage
                currentStudent.password = next;
                sessionStorage.setItem('studentData', JSON.stringify(currentStudent));
                
                // Clear password fields
                document.getElementById('currentPassword').value = '';
                document.getElementById('newPassword').value = '';
                document.getElementById('confirmNewPassword').value = '';

                // Mark that password has been changed
                sessionStorage.setItem('passwordChanged', 'true');
                
                statusEl.textContent = 'Password updated successfully!';
                statusEl.style.color = '#34d399';
                setTimeout(() => statusEl.textContent = '', 5000);
            } catch (err) {
                console.error('Change password error', err);
                showLocalError('Error updating password: ' + (err.message || 'Unknown error'));
            } finally {
                btn.disabled = false;
                btn.textContent = prevText;
            }
        });

        // Load profile on page load
        loadProfile();
        
        // Initialize theme toggle switch
        (function initThemeToggle() {
            const toggleInput = document.getElementById('themeToggleInput');
            const track = document.querySelector('.switch-track');
            const thumb = document.querySelector('.switch-thumb');
            
            if (!toggleInput || !track || !thumb) return;
            
            // Get current theme
            const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
            
            // Set initial state
            if (currentTheme === 'dark') {
                toggleInput.checked = true;
                track.style.background = '#4f46e5';
                thumb.style.transform = 'translateX(20px)';
            } else {
                toggleInput.checked = false;
                track.style.background = '#e5e7eb';
                thumb.style.transform = 'translateX(0)';
            }
            
            // Handle toggle
            toggleInput.addEventListener('change', (e) => {
                const newTheme = e.target.checked ? 'dark' : 'light';
                document.documentElement.setAttribute('data-theme', newTheme);
                document.documentElement.setAttribute('data-bs-theme', newTheme);
                localStorage.setItem('theme', newTheme);
                
                // Animate switch
                if (newTheme === 'dark') {
                    track.style.background = '#4f46e5';
                    thumb.style.transform = 'translateX(20px)';
                } else {
                    track.style.background = '#e5e7eb';
                    thumb.style.transform = 'translateX(0)';
                }
            });
        })();
    </script>
</body>
</html>
