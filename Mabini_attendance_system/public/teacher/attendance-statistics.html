<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendance Statistics - Mabini HS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="../assets/css/admin-theme.css">
    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script>
        (function(){
            try{
                const userData=sessionStorage.getItem('userData');
                if(userData){
                    const user=JSON.parse(userData);
                    window.__userProfileData = {
                        name: user.fullName||'Teacher',
                        role: user.role ? user.role.charAt(0).toUpperCase()+user.role.slice(1) : 'Teacher',
                        initials: (user.fullName||'TE').split(' ').map(function(n){return n[0]}).join('').toUpperCase().slice(0,2)
                    };
                } else {
                    window.__userProfileData = {name:'Teacher',role:'Teacher',initials:'TE'};
                }
            }catch(e){
                window.__userProfileData = {name:'Teacher',role:'Teacher',initials:'TE'};
            }
        })();
    </script>
    <link rel="stylesheet" href="../assets/css/responsive-nav.css">
    <link rel="stylesheet" href="../assets/css/responsive-tables.css">
    <link rel="stylesheet" href="../assets/css/table-improvements.css">
    <link rel="stylesheet" href="css/teacher-mobile.css">
    <script>
        (function() {
            const storedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const theme = storedTheme || (prefersDark ? 'dark' : 'light');
            document.documentElement.setAttribute('data-theme', theme);
            document.documentElement.setAttribute('data-bs-theme', theme);
        })();
    </script>
    <script src="../assets/js/theme.js" defer></script>
    <script src="js/teacher-mobile-utils.js" defer></script>
    <style>
        .stat-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid var(--border-color);
            transition: transform 0.2s;
        }
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            margin: 0.5rem 0;
        }
        .stat-label {
            color: var(--text-muted);
            font-size: 0.9rem;
        }
        .low-attendance-badge {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .at-risk-badge {
            background: linear-gradient(135deg, #ffd93d 0%, #ffb800 100%);
            color: #000;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .progress-bar-custom {
            height: 8px;
            border-radius: 4px;
            background: var(--border-color);
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <button class="sidebar-toggle" onclick="toggleSidebar()" style="display: none;">
        <i class="bi bi-list"></i>
    </button>
    <div class="sidebar-backdrop" onclick="closeSidebar()"></div>
    <div class="admin-layout">
        <!-- Sidebar -->
        <aside class="admin-sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <i class="bi bi-mortarboard-fill"></i>
                    <span>Mabini HS</span>
                </div>
                <div class="sidebar-subtitle">Teacher Portal</div>
            </div>
            <div class="sidebar-menu">
                <div class="menu-label">Main</div>
                <a href="dashboard.html" class="menu-item">
                    <i class="bi bi-speedometer2"></i>
                    <span>Dashboard</span>
                </a>
                
                <div class="menu-label">My Classes</div>
                <a href="sections.html" class="menu-item">
                    <i class="bi bi-grid-3x3-gap-fill"></i>
                    <span>My Sections</span>
                </a>
                <a href="students.html" class="menu-item">
                    <i class="bi bi-people-fill"></i>
                    <span>My Students</span>
                </a>
                <a href="subjects.html" class="menu-item">
                    <i class="bi bi-book-fill"></i>
                    <span>My Subjects</span>
                </a>
                <a href="teaching-loads.html" class="menu-item">
                    <i class="bi bi-calendar-check-fill"></i>
                    <span>Teaching Schedule</span>
                </a>
                
                <div class="menu-label">Attendance</div>
                <a href="attendance-records.html" class="menu-item">
                    <i class="bi bi-clipboard-check-fill"></i>
                    <span>Attendance Records</span>
                </a>
                <a href="attendance-statistics.html" class="menu-item active">
                    <i class="bi bi-bar-chart-fill"></i>
                    <span>Attendance Stats</span>
                </a>
                
                <div class="menu-label">Account</div>
                <a href="settings.html" class="menu-item">
                    <i class="bi bi-gear-fill"></i>
                    <span>Settings</span>
                </a>
            </div>
            
            <div class="sidebar-footer">
                <div class="user-profile">
                    <div class="user-avatar" id="userAvatar"><script>document.write(window.__userProfileData.initials)</script></div>
                    <div class="user-details">
                        <div class="user-name" id="userName"><script>document.write(window.__userProfileData.name)</script></div>
                        <div class="user-role" id="userRole"><script>document.write(window.__userProfileData.role)</script></div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="admin-main">
            <header class="admin-top" role="banner">
                <div style="display:flex;flex-direction:column;">
                    <div class="admin-breadcrumb muted">
                        <span class="muted">Teacher</span>
                        <span aria-hidden="true">/</span>
                        <span id="admin-section">Attendance Statistics</span>
                    </div>
                    <div class="admin-title">Attendance Analytics</div>
                </div>

                <div class="admin-top-actions">
                    <button id="themeToggle" class="theme-toggle" aria-pressed="false" aria-label="Toggle theme">
                        <span class="icon sun" aria-hidden="true" style="display:inline-block">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="4" stroke="currentColor" stroke-width="1.2"/><path d="M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2M4.93 19.07l1.41-1.41M17.66 6.34l1.41-1.41" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                        </span>
                        <span class="icon moon" aria-hidden="true" style="display:none">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                        </span>
                    </button>

                    <div style="display:flex;align-items:center;gap:10px">
                        <div class="avatar" title="Teacher" aria-hidden="true">
                            <svg width="38" height="38" viewBox="0 0 24 24" fill="none"><circle cx="12" cy="8" r="3" stroke="currentColor" stroke-width="1.2"/><path d="M4 20c1.5-4 6-6 8-6s6.5 2 8 6" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                        </div>
                        <button id="logoutBtn" class="btn btn-danger" aria-label="Logout">Logout</button>
                    </div>
                </div>
            </header>

            <div class="content-area">
                <!-- Statistics Overview -->
                <div class="row g-3 mb-4">
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-label">
                                <i class="bi bi-people-fill text-primary"></i> Total Students
                            </div>
                            <div class="stat-number text-primary" id="totalStudents">0</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-label">
                                <i class="bi bi-check-circle-fill text-success"></i> Average Attendance
                            </div>
                            <div class="stat-number text-success" id="avgAttendance">0%</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-label">
                                <i class="bi bi-exclamation-triangle-fill text-warning"></i> At Risk
                            </div>
                            <div class="stat-number text-warning" id="atRiskCount">0</div>
                            <small class="text-muted">50-75% attendance</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-label">
                                <i class="bi bi-x-circle-fill text-danger"></i> Low Attendance
                            </div>
                            <div class="stat-number text-danger" id="lowAttendanceCount">0</div>
                            <small class="text-muted">Below 50%</small>
                        </div>
                    </div>
                </div>

                <!-- Filters -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h6 class="card-title mb-0">Filters</h6>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label">Filter by Section</label>
                                <select class="form-select" id="sectionFilter" onchange="filterStudents()">
                                    <option value="">All Sections</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Filter by Status</label>
                                <select class="form-select" id="statusFilter" onchange="filterStudents()">
                                    <option value="">All Students</option>
                                    <option value="low">Low Attendance (< 50%)</option>
                                    <option value="at-risk">At Risk (50-75%)</option>
                                    <option value="good">Good (> 75%)</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Search</label>
                                <input type="text" class="form-control" id="searchInput" placeholder="Search by name or ID..." onkeyup="filterStudents()">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Students List -->
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="card-title mb-0">Student Attendance Records</h6>
                        <button class="btn btn-sm btn-primary" onclick="exportData()">
                            <i class="bi bi-download me-1"></i>Export CSV
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Student ID</th>
                                        <th>Name</th>
                                        <th>Section</th>
                                        <th>Total Records</th>
                                        <th>Present</th>
                                        <th>Absent</th>
                                        <th>Attendance Rate</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="studentsTableBody">
                                    <tr>
                                        <td colspan="8" class="text-center">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="../shared/js/toast.js"></script>
    <script src="../shared/js/loading.js"></script>
    <script type="module" src="js/teacher-common.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let allStudentsData = [];
        let mySections = [];
        let currentTeacherId = null;

        // Wait for teacher-common.js to load
        async function waitForGetDocuments() {
            let attempts = 0;
            while (!window.getDocuments && attempts < 50) {
                await new Promise(resolve => setTimeout(resolve, 100));
                attempts++;
            }
            if (!window.getDocuments) {
                console.error('Failed to load getDocuments function');
                return false;
            }
            return true;
        }

        // Load attendance statistics
        async function loadAttendanceStatistics() {
            // Wait for getDocuments to be available
            const ready = await waitForGetDocuments();
            if (!ready) {
                document.getElementById('studentsTableBody').innerHTML = `
                    <tr><td colspan="8" class="text-center text-danger">Error: Required functions not loaded</td></tr>
                `;
                return;
            }

            try {
                // Get current teacher ID
                const userData = JSON.parse(sessionStorage.getItem('userData'));
                if (!userData || !userData.id) {
                    console.error('No valid user data found');
                    setTimeout(() => window.location.href = 'login.html', 2000);
                    return;
                }
                currentTeacherId = userData.id;

                // Get teaching loads to find teacher's sections
                const teachingLoads = await window.getDocuments('teaching_loads');
                const mySectionIds = [...new Set(
                    teachingLoads
                        .filter(load => String(load.teacher_id) === String(currentTeacherId))
                        .map(load => load.section_id)
                )];

                // Get sections
                const sections = await window.getDocuments('sections');
                mySections = sections.filter(s => mySectionIds.some(sId => String(sId) === String(s.id)));

                // Populate section filter
                const sectionFilter = document.getElementById('sectionFilter');
                sectionFilter.innerHTML = '<option value="">All Sections</option>' +
                    mySections.map(s => `<option value="${s.id}">${s.section_name || s.name}</option>`).join('');

                // Get students in these sections
                const students = await window.getDocuments('students');
                const myStudents = students.filter(st => mySectionIds.some(sId => String(sId) === String(st.section_id)));

                // Get all attendance records
                const attendanceRecords = await window.getDocuments('attendance');

                // Calculate statistics for each student
                allStudentsData = myStudents.map(student => {
                    const section = mySections.find(s => String(s.id) === String(student.section_id));
                    const studentRecords = attendanceRecords.filter(r => String(r.student_id) === String(student.id));
                    
                    const totalRecords = studentRecords.length;
                    const presentRecords = studentRecords.filter(r => r.status === 'present').length;
                    const absentRecords = studentRecords.filter(r => r.status === 'absent').length;
                    const attendanceRate = totalRecords > 0 ? Math.round((presentRecords / totalRecords) * 100) : 0;

                    return {
                        ...student,
                        sectionName: section ? (section.section_name || section.name) : 'Unknown',
                        totalRecords,
                        presentRecords,
                        absentRecords,
                        attendanceRate
                    };
                });

                // Update summary statistics
                updateSummaryStats(allStudentsData);

                // Render table
                renderStudentsTable(allStudentsData);

            } catch (error) {
                console.error('Error loading attendance statistics:', error);
                document.getElementById('studentsTableBody').innerHTML = `
                    <tr><td colspan="8" class="text-center text-danger">Error loading data</td></tr>
                `;
            }
        }

        // Update summary statistics
        function updateSummaryStats(data) {
            const totalStudents = data.length;
            const avgAttendance = totalStudents > 0 
                ? Math.round(data.reduce((sum, s) => sum + s.attendanceRate, 0) / totalStudents)
                : 0;
            const atRisk = data.filter(s => s.attendanceRate >= 50 && s.attendanceRate < 75).length;
            const lowAttendance = data.filter(s => s.attendanceRate < 50).length;

            document.getElementById('totalStudents').textContent = totalStudents;
            document.getElementById('avgAttendance').textContent = avgAttendance + '%';
            document.getElementById('atRiskCount').textContent = atRisk;
            document.getElementById('lowAttendanceCount').textContent = lowAttendance;
        }

        // Render students table
        function renderStudentsTable(data) {
            const tbody = document.getElementById('studentsTableBody');

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center">No students found</td></tr>';
                return;
            }

            tbody.innerHTML = data.map(student => {
                const statusBadge = student.attendanceRate < 50
                    ? '<span class="low-attendance-badge"><i class="bi bi-exclamation-circle me-1"></i>Low</span>'
                    : student.attendanceRate < 75
                    ? '<span class="at-risk-badge"><i class="bi bi-exclamation-triangle me-1"></i>At Risk</span>'
                    : '<span class="badge bg-success">Good</span>';

                const progressColor = student.attendanceRate < 50 ? '#ff6b6b' : student.attendanceRate < 75 ? '#ffd93d' : '#51cf66';

                return `
                    <tr>
                        <td><strong>${student.student_number || 'N/A'}</strong></td>
                        <td>${student.first_name} ${student.last_name}</td>
                        <td>${student.sectionName}</td>
                        <td>${student.totalRecords}</td>
                        <td><span class="badge bg-success">${student.presentRecords}</span></td>
                        <td><span class="badge bg-danger">${student.absentRecords}</span></td>
                        <td>
                            <div class="d-flex align-items-center gap-2">
                                <div class="progress-bar-custom flex-grow-1">
                                    <div class="progress-fill" style="width: ${student.attendanceRate}%; background: ${progressColor};"></div>
                                </div>
                                <strong style="min-width: 40px;">${student.attendanceRate}%</strong>
                            </div>
                        </td>
                        <td>${statusBadge}</td>
                    </tr>
                `;
            }).join('');
        }

        // Filter students
        window.filterStudents = function() {
            const sectionFilter = document.getElementById('sectionFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();

            let filtered = allStudentsData.filter(student => {
                // Section filter
                const matchesSection = !sectionFilter || String(student.section_id) === sectionFilter;

                // Status filter
                let matchesStatus = true;
                if (statusFilter === 'low') {
                    matchesStatus = student.attendanceRate < 50;
                } else if (statusFilter === 'at-risk') {
                    matchesStatus = student.attendanceRate >= 50 && student.attendanceRate < 75;
                } else if (statusFilter === 'good') {
                    matchesStatus = student.attendanceRate >= 75;
                }

                // Search filter
                const name = `${student.first_name} ${student.last_name}`.toLowerCase();
                const id = (student.student_number || '').toLowerCase();
                const matchesSearch = !searchTerm || name.includes(searchTerm) || id.includes(searchTerm);

                return matchesSection && matchesStatus && matchesSearch;
            });

            updateSummaryStats(filtered);
            renderStudentsTable(filtered);
        };

        // Export data to PDF with embedded images
        window.exportData = async function() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l', 'mm', 'a4'); // Landscape orientation
            
            // Add title
            doc.setFontSize(18);
            doc.text('Attendance Statistics Report', 14, 20);
            
            // Add date
            doc.setFontSize(10);
            doc.text(`Generated: ${new Date().toLocaleDateString()}`, 14, 28);
            
            // Prepare table data with image loading
            const tableData = [];
            
            for (const student of allStudentsData) {
                const status = student.attendanceRate < 50 ? 'Low' : student.attendanceRate < 75 ? 'At Risk' : 'Good';
                
                tableData.push([
                    student.student_number || 'N/A',
                    `${student.first_name} ${student.last_name}`,
                    student.email || 'N/A',
                    student.sectionName,
                    `Grade ${student.grade_level || 'N/A'}`,
                    student.totalRecords.toString(),
                    student.presentRecords.toString(),
                    student.absentRecords.toString(),
                    `${student.attendanceRate}%`,
                    status
                ]);
            }
            
            // Generate table without photos
            doc.autoTable({
                head: [['Student ID', 'Name', 'Email', 'Section', 'Grade', 'Total', 'Present', 'Absent', 'Rate', 'Status']],
                body: tableData,
                startY: 35,
                styles: { fontSize: 8, cellPadding: 2 },
                headStyles: { fillColor: [41, 128, 185], textColor: 255 },
                columnStyles: {
                    0: { cellWidth: 22 }, // Student ID
                    1: { cellWidth: 35 }, // Name
                    2: { cellWidth: 40 }, // Email
                    9: { cellWidth: 18 } // Status
                },
                rowPageBreak: 'avoid',
                margin: { top: 35 }
            });
            
            // Save the PDF
            doc.save(`attendance_statistics_${new Date().toISOString().split('T')[0]}.pdf`);
        };
        
        // Helper function to load image and convert to base64
        function loadImageAsBase64(url) {
            return new Promise((resolve, reject) => {
                // If it's already base64 with data:image prefix, return it
                if (url.startsWith('data:image')) {
                    resolve(url);
                    return;
                }
                
                // If it looks like base64 without prefix, add the prefix
                if (url.length > 100 && !url.startsWith('http') && !url.startsWith('/')) {
                    // Assume it's a base64 QR code
                    const base64Data = url.startsWith('data:') ? url : `data:image/png;base64,${url}`;
                    resolve(base64Data);
                    return;
                }
                
                // Otherwise, load as URL
                const img = new Image();
                img.crossOrigin = 'Anonymous';
                
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0);
                    
                    try {
                        const dataURL = canvas.toDataURL('image/jpeg', 0.7);
                        resolve(dataURL);
                    } catch (err) {
                        reject(err);
                    }
                };
                
                img.onerror = function() {
                    reject(new Error('Failed to load image'));
                };
                
                img.src = url;
            });
        }

        // Logout handler
        document.getElementById('logoutBtn')?.addEventListener('click', function() {
            sessionStorage.clear();
            window.location.href = 'login.html';
        });

        // Load data on page load
        window.addEventListener('load', async () => {
            await loadAttendanceStatistics();
        });
    </script>
</body>
</html>
