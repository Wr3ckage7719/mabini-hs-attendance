<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings - Teacher Portal</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="../assets/css/admin-theme.css">
    <link rel="stylesheet" href="../assets/css/responsive-nav.css">
    <link rel="stylesheet" href="../assets/css/responsive-tables.css">
    <link rel="stylesheet" href="../assets/css/table-improvements.css">
    <script>
        // Apply theme immediately to prevent flash
        (function() {
            const storedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const theme = storedTheme || (prefersDark ? 'dark' : 'light');
            document.documentElement.setAttribute('data-theme', theme);
            document.documentElement.setAttribute('data-bs-theme', theme);
        })();
    </script>
    <script src="../assets/js/theme.js" defer></script>
    <style>
        /* Additional Settings Styles */
        .settings-section {
            background: rgba(30, 41, 59, 0.6);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(148, 163, 184, 0.1);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
        }
        
        .section-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            color: white;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .card {
            background: rgba(30, 41, 59, 0.6);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(148, 163, 184, 0.1);
            border-radius: 16px;
        }
        
        .card-body {
            padding: 2rem;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-label {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #cbd5e1;
            font-size: 0.875rem;
        }
        
        .form-description {
            font-size: 0.75rem;
            color: #94a3b8;
            margin-bottom: 0.5rem;
        }
        
        .form-input, .form-select {
            width: 100%;
            padding: 0.75rem 1rem;
            background: rgba(15, 23, 42, 0.8);
            border: 2px solid rgba(148, 163, 184, 0.2);
            border-radius: 10px;
            color: white;
            font-size: 0.95rem;
            transition: all 0.3s;
        }
        
        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #60a5fa;
            background: rgba(15, 23, 42, 0.95);
        }
        
        .form-input:read-only {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #001f5b 0%, #00306e 100%);
            color: white;
            padding: 0.875rem 2rem;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 31, 91, 0.3);
        }
        
        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-secondary {
            background: rgba(100, 116, 139, 0.3);
            color: white;
            padding: 0.875rem 2rem;
            border: 2px solid rgba(148, 163, 184, 0.3);
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-left: 1rem;
        }
        
        .btn-secondary:hover {
            background: rgba(100, 116, 139, 0.5);
            border-color: rgba(148, 163, 184, 0.5);
        }
        
        .alert {
            padding: 1rem 1.25rem;
            border-radius: 10px;
            margin-bottom: 1.5rem;
            animation: slideDown 0.3s ease-out;
        }
        
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .alert-success {
            background: rgba(16, 185, 129, 0.2);
            border: 1px solid rgba(16, 185, 129, 0.4);
            color: #6ee7b7;
        }
        
        .alert-error {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.4);
            color: #fca5a5;
        }
        
        .btn-group {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
        }
        
        textarea.form-input {
            min-height: 100px;
            resize: vertical;
            font-family: inherit;
        }
        /* Responsive fixes for mobile views */
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr !important;
                gap: 12px;
            }
            .actions-grid {
                grid-template-columns: 1fr !important;
            }
            .btn-group {
                flex-direction: column;
                gap: 0.75rem;
            }
            /* Make change password button full width on mobile and status sit below */
            #changePasswordBtn {
                width: 100%;
                box-sizing: border-box;
            }
            #changePasswordStatus {
                display: block;
                margin-top: 0.5rem;
            }
            .settings-section {
                padding: 1.25rem;
            }
        }
    </style>
</head>
<body>
    <button class="sidebar-toggle" onclick="toggleSidebar()" style="display: none;">
        <i class="bi bi-list"></i>
    </button>
    <div class="sidebar-backdrop" onclick="closeSidebar()"></div>
    <div class="admin-layout">
        <!-- Sidebar -->
        <aside class="admin-sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <i class="bi bi-mortarboard-fill"></i>
                    <span>Mabini HS</span>
                </div>
                <div class="sidebar-subtitle">Teacher Portal</div>
            </div>
            
            <div class="sidebar-menu">
                <div class="menu-label">Main</div>
                <a href="dashboard.html" class="menu-item">
                    <i class="bi bi-speedometer2"></i>
                    <span>Dashboard</span>
                </a>
                
                <div class="menu-label">My Classes</div>
                <a href="sections.html" class="menu-item">
                    <i class="bi bi-grid-3x3-gap-fill"></i>
                    <span>My Sections</span>
                </a>
                <a href="students.html" class="menu-item">
                    <i class="bi bi-people-fill"></i>
                    <span>My Students</span>
                </a>
                <a href="subjects.html" class="menu-item">
                    <i class="bi bi-book-fill"></i>
                    <span>My Subjects</span>
                </a>
                <a href="teaching-loads.html" class="menu-item">
                    <i class="bi bi-calendar-check-fill"></i>
                    <span>Teaching Schedule</span>
                </a>
                
                <div class="menu-label">Account</div>
                <a href="settings.html" class="menu-item active">
                    <i class="bi bi-gear-fill"></i>
                    <span>Settings</span>
                </a>
            </div>
            
            <div class="sidebar-footer">
                <div class="user-profile">
                    <div class="user-avatar" id="userAvatar">TE</div>
                    <div class="user-details">
                        <div class="user-name" id="userName">Teacher</div>
                        <div class="user-role" id="userRole">Teacher</div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="admin-main">
            <header class="admin-top" role="banner">
                <div style="display:flex;flex-direction:column;">
                    <div class="admin-breadcrumb muted">
                        <span class="muted">Teacher</span>
                        <span aria-hidden="true">/</span>
                        <span>Settings</span>
                    </div>
                    <div class="admin-title">Account Settings</div>
                </div>

                <div class="admin-top-actions">
                    <button id="themeToggle" class="theme-toggle" aria-pressed="false" aria-label="Toggle theme">
                        <span class="icon sun" aria-hidden="true" style="display:inline-block">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="4" stroke="currentColor" stroke-width="1.2"/><path d="M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2M4.93 19.07l1.41-1.41M17.66 6.34l1.41-1.41" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                        </span>
                        <span class="icon moon" aria-hidden="true" style="display:none">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                        </span>
                    </button>

                    <div style="display:flex;align-items:center;gap:10px">
                        <div class="avatar" title="Teacher" aria-hidden="true">
                            <svg width="38" height="38" viewBox="0 0 24 24" fill="none"><circle cx="12" cy="8" r="3" stroke="currentColor" stroke-width="1.2"/><path d="M4 20c1.5-4 6-6 8-6s6.5 2 8 6" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                        </div>
                        <button id="logoutBtn" class="btn ghost" aria-label="Logout">Logout</button>
                    </div>
                </div>
            </header>
        
            <div class="content-area">
                <div id="alertContainer"></div>

        <div id="alert-container"></div>

        <form id="profile-form">
            <!-- Account Settings -->
            <div class="settings-section">
                <h2 class="section-title">Account Settings</h2>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Full Name *</label>
                        <div class="form-description">Your full name as displayed in the system</div>
                        <input type="text" id="fullName" class="form-input" placeholder="Enter full name" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Email Address</label>
                        <div class="form-description">Your email for notifications and login</div>
                        <input type="email" id="email" class="form-input" readonly>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Profile Photo</label>
                        <div class="form-description">Upload a profile picture (optional). Preview will show after selection.</div>
                        <div style="display:flex;gap:1rem;align-items:center;">
                            <img id="photoPreview" src="" alt="Profile preview" style="width:80px;height:80px;border-radius:50%;object-fit:cover;display:none;border:2px solid rgba(148,163,184,0.15);" />
                            <div style="display:flex;flex-direction:column;gap:0.5rem;flex:1;">
                                <input type="file" id="photoInput" accept="image/*" class="form-input" style="padding:0.35rem;"/>
                                <button type="button" id="removePhotoBtn" class="btn-secondary" style="width:fit-content;">Remove Photo</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Department</label>
                        <div class="form-description">Assigned by administrator</div>
                        <input type="text" id="department" class="form-input" readonly>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Position</label>
                        <div class="form-description">Assigned by administrator</div>
                        <input type="text" id="position" class="form-input" readonly>
                    </div>
                </div>
            </div>

            <!-- Contact Information -->
            <div class="settings-section">
                <h2 class="section-title">Contact Information</h2>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Phone Number</label>
                        <div class="form-description">Your contact number</div>
                        <input type="tel" id="phone" class="form-input" placeholder="09XXXXXXXXX">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Contact Email</label>
                        <div class="form-description">Alternative contact email</div>
                        <input type="email" id="contactEmail" class="form-input" placeholder="your.email@example.com">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Address</label>
                    <div class="form-description">Your complete address</div>
                    <textarea id="address" class="form-input" placeholder="Enter your address"></textarea>
                </div>
            </div>

            <!-- Personal Information -->
            <div class="settings-section">
                <h2 class="section-title">Personal Information</h2>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Sex</label>
                        <select id="sex" class="form-select">
                            <option value="">Select</option>
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Nationality</label>
                        <input type="text" id="nationality" class="form-input" placeholder="e.g., Filipino">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Birth Date</label>
                        <input type="date" id="birthDate" class="form-input">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Birth Place</label>
                        <input type="text" id="birthPlace" class="form-input" placeholder="City, Province">
                    </div>
                </div>
            </div>

            <!-- Save Buttons -->

            <!-- Change Password -->
            <div class="settings-section" id="change-password-section">
                <h2 class="section-title">Change Password</h2>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Current Password</label>
                        <input type="password" id="currentPassword" class="form-input" placeholder="Enter your current password">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">New Password</label>
                        <input type="password" id="newPassword" class="form-input" placeholder="Enter your new password">
                        <div class="form-description">Password must be at least 8 characters, include uppercase, lowercase and a number.</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Confirm New Password</label>
                        <input type="password" id="confirmNewPassword" class="form-input" placeholder="Re-enter your new password">
                    </div>
                </div>

                <div style="margin-top:1rem; display:flex; gap:1rem; align-items:center;">
                    <button type="button" id="changePasswordBtn" class="btn-primary">Update Password</button>
                    <div id="changePasswordStatus" style="color:#cbd5e1; font-size:0.95rem;"></div>
                </div>
            </div>

            <div class="btn-group">
                <button type="submit" class="btn-primary" id="save-btn">
                    Save Changes
                </button>
            </div>
        </form>
    </div>

    <script src="../shared/js/toast.js"></script>
    <script src="../shared/js/confirm-modal.js"></script>
    <script src="../shared/js/empty-state.js"></script>
    <script src="../shared/js/loading.js"></script>
    <script type="module" src="js/teacher-common.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        import { dataClient } from '../js/data-client.js';

        let userData = null;
        let currentTeacher = null;

        // Check teacher authentication from session
        const teacherData = sessionStorage.getItem('teacherData');
        const userRole = sessionStorage.getItem('userRole');
        
        if (!teacherData || userRole !== 'teacher') {
            console.log('Not authenticated as teacher, redirecting to login');
            window.location.href = 'login.html';
            throw new Error('Not authenticated');
        }
        
        userData = JSON.parse(teacherData);
        console.log('Current teacher:', userData);

        // Load profile data
        async function loadProfile() {
            try {
                // Find teacher by email
                const teacher = await dataClient.query('teachers', {
                    filter: { email: userData.email },
                    single: true
                });

                console.log('Load profile result:', teacher);
                
                if (teacher) {
                    currentTeacher = teacher;
                    const profile = teacher;
                    
                    // Populate form fields
                    document.getElementById('fullName').value = profile.full_name || profile.fullName || (profile.first_name + ' ' + profile.last_name) || '';
                    document.getElementById('email').value = profile.email || '';
                    document.getElementById('department').value = profile.department || '';
                    document.getElementById('position').value = profile.position || '';
                    document.getElementById('phone').value = profile.phone || '';
                    document.getElementById('contactEmail').value = profile.contact_email || profile.contactEmail || '';
                    document.getElementById('address').value = profile.address || '';
                    document.getElementById('sex').value = profile.sex || '';
                    document.getElementById('nationality').value = profile.nationality || '';
                    document.getElementById('birthDate').value = profile.birth_date || profile.birthDate || '';
                    document.getElementById('birthPlace').value = profile.birth_place || profile.birthPlace || '';
                    // Load profile photo if present
                    if (profile.profile_photo) {
                        profilePhotoBase64 = profile.profile_photo;
                        photoPreview.src = profilePhotoBase64;
                        photoPreview.style.display = 'block';
                    } else {
                        profilePhotoBase64 = null;
                        photoPreview.src = '';
                        photoPreview.style.display = 'none';
                    }
                } else {
                    console.error('Failed to load profile:', result.error);
                    showAlert('Failed to load profile: ' + (result.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                console.error('Load profile error:', error);
                showAlert('Failed to load profile data', 'error');
            }
        }

        // Save profile
        document.getElementById('profile-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const saveBtn = document.getElementById('save-btn');
            saveBtn.disabled = true;
            saveBtn.innerHTML = 'Saving...';

            try {
                const profileData = {
                    full_name: document.getElementById('fullName').value.trim(),
                    phone: document.getElementById('phone').value.trim(),
                    contact_email: document.getElementById('contactEmail').value.trim(),
                    address: document.getElementById('address').value.trim(),
                    sex: document.getElementById('sex').value,
                    nationality: document.getElementById('nationality').value.trim(),
                    birth_date: document.getElementById('birthDate').value,
                    birth_place: document.getElementById('birthPlace').value.trim(),
                    updated_at: new Date().toISOString(),
                    profile_photo: profilePhotoBase64
                };

                await dataClient.update('teachers', currentTeacher.id, profileData);
                const result = { success: true };
                console.log('Update result:', result);

                if (result.success) {
                    showAlert('Profile updated successfully!', 'success');
                    
                    // Update session storage
                    userData.fullName = profileData.full_name;
                    sessionStorage.setItem('userData', JSON.stringify(userData));
                    
                    // Reload profile to show updated data
                    setTimeout(() => loadProfile(), 1000);
                } else {
                    showAlert(result.error || 'Failed to update profile', 'error');
                }
            } catch (error) {
                console.error('Save error:', error);
                showAlert('Failed to save changes. Please try again.', 'error');
            } finally {
                saveBtn.disabled = false;
                saveBtn.innerHTML = 'Save Changes';
            }
        });

        // Show alert
        function showAlert(message, type = 'success') {
            const alertContainer = document.getElementById('alert-container');
            alertContainer.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => alertContainer.innerHTML = '', 5000);
        }

        // Initialize logout button
        document.getElementById('logoutBtn')?.addEventListener('click', () => {
            if (confirm('Are you sure you want to logout?')) {
                sessionStorage.removeItem('userData');
                window.location.href = 'login.html';
            }
        });

        // Profile photo data (base64)
        let profilePhotoBase64 = null;

        // Handle photo input
        const photoInput = document.getElementById('photoInput');
        const photoPreview = document.getElementById('photoPreview');
        const removePhotoBtn = document.getElementById('removePhotoBtn');

        photoInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(evt) {
                profilePhotoBase64 = evt.target.result;
                photoPreview.src = profilePhotoBase64;
                photoPreview.style.display = 'block';
            };
            reader.readAsDataURL(file);
        });

        removePhotoBtn.addEventListener('click', () => {
            profilePhotoBase64 = null;
            photoPreview.src = '';
            photoPreview.style.display = 'none';
            photoInput.value = '';
        });

        // Change Password handler
        document.getElementById('changePasswordBtn').addEventListener('click', async () => {
            const current = document.getElementById('currentPassword').value.trim();
            const next = document.getElementById('newPassword').value.trim();
            const confirm = document.getElementById('confirmNewPassword').value.trim();
            const statusEl = document.getElementById('changePasswordStatus');

            function showLocalError(msg) {
                statusEl.textContent = msg;
                statusEl.style.color = '#fca5a5';
                setTimeout(() => statusEl.textContent = '', 5000);
            }

            // Basic client-side validation
            if (!current) return showLocalError('Enter your current password');
            if (!next) return showLocalError('Enter a new password');
            if (next !== confirm) return showLocalError('New passwords do not match');
            if (next.length < 8) return showLocalError('Password must be at least 8 characters');
            if (!/[A-Z]/.test(next)) return showLocalError('Include at least one uppercase letter');
            if (!/[a-z]/.test(next)) return showLocalError('Include at least one lowercase letter');
            if (!/[0-9]/.test(next)) return showLocalError('Include at least one number');

            const btn = document.getElementById('changePasswordBtn');
            btn.disabled = true;
            const prevText = btn.textContent;
            btn.textContent = 'Updating...';

            try {
                const res = await fetch(AUTH_API, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'change_password', current_password: current, new_password: next })
                });
                const data = await res.json();
                if (data && data.success) {
                    showAlert('Password updated successfully', 'success');
                    document.getElementById('currentPassword').value = '';
                    document.getElementById('newPassword').value = '';
                    document.getElementById('confirmNewPassword').value = '';
                } else {
                    const err = (data && (data.error || data.message)) || 'Failed to update password';
                    showAlert(err, 'error');
                }
            } catch (err) {
                console.error('Change password error', err);
                showAlert('Error updating password', 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = prevText;
            }
        });

        // Load profile on page load
        loadProfile();
    </script>
</body>
</html>
